'use strict';

Object.defineProperty(exports, "__esModule", {
		value: true
});
exports.shake = shake;
function shake(out, tree, variables, args) {

		let variable, buffer, cmd, nargs, expandsto;

		while (tree.nonterminal === 0) {
				// eliminate expensive tail-recursion
				if (tree.production.id === 1) return;
				shake(out, tree.children[0], variables, args); // 1
				tree = tree.children[1]; // 0
		}

		switch (tree.nonterminal) {
				case 1:
						switch (tree.production.id) {
								case 0:
										out.write(tree.children[0].buffer); // text
										break;
								case 1:
										// newif
										// ifcmd
										break;
								case 2:
										variable = tree.children[0].buffer.substr(3); // ifcmd
										const flag = variables.get(variable);
										if (flag) shake(out, tree.children[1], variables, args);else if (tree.children[2].production.id === 0) {
												// else
												shake(out, tree.children[2].children[1], variables, args);
										}
										// fi
										break;
								case 3:
										buffer = tree.children[0].buffer; // falsecmd
										variable = buffer.substring(1, buffer.length - 5);
										variables.set(variable, false);
										break;
								case 4:
										buffer = tree.children[0].buffer; // truecmd
										variable = buffer.substring(1, buffer.length - 4);
										variables.set(variable, true);
										break;
								case 5:
										out.write('%'); // comment
										break;
								case 6:
										cmd = tree.children[0].buffer; // othercmd
										if (tree.children[1].production.id === 0) cmd += '*';
										const optargsnode = tree.children[2];
										const hasoptargs = optargsnode.production.id === 0;
										let argsnode = tree.children[3];
										const cmdargs = [];
										while (argsnode.production.id === 0) {
												// {
												cmdargs.push(argsnode.children[1]);
												// }
												argsnode = argsnode.children[3];
										}
										if (!hasoptargs && variables.has(cmd)) {
												// too hard to parse opt args currently
												[nargs, expandsto] = variables.get(cmd);
												if (cmdargs.length !== nargs) throw new Error('nargs does not match');
												shake(out, expandsto, variables, [args, cmdargs]);
										} else {
												out.write(cmd);
												if (hasoptargs) {
														out.write('[');
														shake(out, optargsnode.children[1], variables, args);
														out.write(']');
												}
												for (const subtree of cmdargs) {
														out.write('{');
														shake(out, subtree, variables, args);
														out.write('}');
												}
										}
										break;
								case 7:
										// def
										cmd = tree.children[1].buffer; // othercmd
										// {
										variables.set(cmd, [0, tree.children[3]]);
										// }
										break;
								case 8:
										// newcommand
										shake(out, tree.children[1], variables, args);
										break;
								case 9:
										out.write('{'); // {
										shake(out, tree.children[1], variables, args);
										out.write('}'); // }
										break;
								case 10:
										out.write('['); // [
										shake(out, tree.children[1], variables, args);
										out.write(']'); // ]
										break;
								case 11:
										out.write('*'); // *
										break;
								case 12:
										//throw new Error('Should never reach case 1.12 because handled before.');
										const i = parseInt(tree.children[0].buffer.substr(1), 10) - 1; // arg
										if (i >= args[1].length) throw new Error('shake 1.12: not enough arguments');
										const subtree = args[1][i]; // arg
										shake(out, subtree, variables, args[0]);
										break;
						}
						break;
				case 2:
						throw new Error('Should never reach case 2 because handled before.');
				case 3:
						switch (tree.production.id) {
								case 0:
										// {
										cmd = tree.children[1].buffer; // othercmd
										// }
										nargs = 0;
										if (tree.children[3].production.id === 0) {
												// [
												nargs = parseInt(tree.children[3].children[1].buffer, 10); // text
												// ]
										}
										// {
										variables.set(cmd, [nargs, tree.children[5]]);
										// }
										break;
								case 1:
										cmd = tree.children[0].buffer; // othercmd
										nargs = 0;
										if (tree.children[1].production.id === 0) {
												// [
												nargs = parseInt(tree.children[1].children[1].buffer, 10); // text
												// ]
										}
										// {
										variables.set(cmd, [nargs, tree.children[3]]);
										// }
										break;
								case 2:
										// *
										cmd = tree.children[1].buffer; // othercmd
										// do not know what to do with '*' at the moment
										nargs = 0;
										if (tree.children[2].production.id === 0) {
												// [
												nargs = parseInt(tree.children[2].children[1].buffer, 10); // text
												// ]
										}
										// {
										variables.set(cmd, [nargs, tree.children[4]]);
										// }
										break;
						}
						break;
				case 4:
						throw new Error('Should never reach case 4 because handled before.');
				case 5:
						throw new Error('Should never reach case 5 because handled before.');
				case 6:
						throw new Error('Should never reach case 6 because handled before.');
				case 7:
						throw new Error('Should never reach case 7 because handled before.');
		}
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zaGFrZS5qcyJdLCJuYW1lcyI6WyJzaGFrZSIsIm91dCIsInRyZWUiLCJ2YXJpYWJsZXMiLCJhcmdzIiwidmFyaWFibGUiLCJidWZmZXIiLCJjbWQiLCJuYXJncyIsImV4cGFuZHN0byIsIm5vbnRlcm1pbmFsIiwicHJvZHVjdGlvbiIsImlkIiwiY2hpbGRyZW4iLCJ3cml0ZSIsInN1YnN0ciIsImZsYWciLCJnZXQiLCJzdWJzdHJpbmciLCJsZW5ndGgiLCJzZXQiLCJvcHRhcmdzbm9kZSIsImhhc29wdGFyZ3MiLCJhcmdzbm9kZSIsImNtZGFyZ3MiLCJwdXNoIiwiaGFzIiwiRXJyb3IiLCJzdWJ0cmVlIiwiaSIsInBhcnNlSW50Il0sIm1hcHBpbmdzIjoiOzs7OztRQUFnQkEsSyxHQUFBQSxLO0FBQVQsU0FBU0EsS0FBVCxDQUFpQkMsR0FBakIsRUFBdUJDLElBQXZCLEVBQThCQyxTQUE5QixFQUEwQ0MsSUFBMUMsRUFBaUQ7O0FBRXRELE1BQUlDLFFBQUosRUFBZUMsTUFBZixFQUF3QkMsR0FBeEIsRUFBOEJDLEtBQTlCLEVBQXNDQyxTQUF0Qzs7QUFFQSxTQUFRUCxLQUFLUSxXQUFMLEtBQXFCLENBQTdCLEVBQWlDO0FBQy9CO0FBQ0EsUUFBS1IsS0FBS1MsVUFBTCxDQUFnQkMsRUFBaEIsS0FBdUIsQ0FBNUIsRUFBZ0M7QUFDaENaLFVBQU9DLEdBQVAsRUFBYUMsS0FBS1csUUFBTCxDQUFjLENBQWQsQ0FBYixFQUFnQ1YsU0FBaEMsRUFBNENDLElBQTVDLEVBSCtCLENBR3NCO0FBQ3JERixXQUFPQSxLQUFLVyxRQUFMLENBQWMsQ0FBZCxDQUFQLENBSitCLENBSU47QUFDMUI7O0FBRUQsVUFBU1gsS0FBS1EsV0FBZDtBQUNFLFNBQUssQ0FBTDtBQUNFLGNBQVNSLEtBQUtTLFVBQUwsQ0FBZ0JDLEVBQXpCO0FBQ0wsYUFBSyxDQUFMO0FBQ0VYLGNBQUlhLEtBQUosQ0FBVVosS0FBS1csUUFBTCxDQUFjLENBQWQsRUFBaUJQLE1BQTNCLEVBREYsQ0FDc0M7QUFDcEM7QUFDRixhQUFLLENBQUw7QUFDRTtBQUNBO0FBQ0E7QUFDRixhQUFLLENBQUw7QUFDRUQscUJBQVdILEtBQUtXLFFBQUwsQ0FBYyxDQUFkLEVBQWlCUCxNQUFqQixDQUF3QlMsTUFBeEIsQ0FBK0IsQ0FBL0IsQ0FBWCxDQURGLENBQ2dEO0FBQzlDLGdCQUFNQyxPQUFPYixVQUFVYyxHQUFWLENBQWNaLFFBQWQsQ0FBYjtBQUNBLGNBQUlXLElBQUosRUFBVWhCLE1BQU1DLEdBQU4sRUFBV0MsS0FBS1csUUFBTCxDQUFjLENBQWQsQ0FBWCxFQUE4QlYsU0FBOUIsRUFBMENDLElBQTFDLEVBQVYsS0FDSyxJQUFLRixLQUFLVyxRQUFMLENBQWMsQ0FBZCxFQUFpQkYsVUFBakIsQ0FBNEJDLEVBQTVCLEtBQW1DLENBQXhDLEVBQTRDO0FBQy9DO0FBQ0FaLGtCQUFNQyxHQUFOLEVBQVdDLEtBQUtXLFFBQUwsQ0FBYyxDQUFkLEVBQWlCQSxRQUFqQixDQUEwQixDQUExQixDQUFYLEVBQTBDVixTQUExQyxFQUFzREMsSUFBdEQ7QUFDRDtBQUNEO0FBQ0E7QUFDRixhQUFLLENBQUw7QUFDRUUsbUJBQVNKLEtBQUtXLFFBQUwsQ0FBYyxDQUFkLEVBQWlCUCxNQUExQixDQURGLENBQ29DO0FBQ2xDRCxxQkFBV0MsT0FBT1ksU0FBUCxDQUFpQixDQUFqQixFQUFtQlosT0FBT2EsTUFBUCxHQUFjLENBQWpDLENBQVg7QUFDQWhCLG9CQUFVaUIsR0FBVixDQUFjZixRQUFkLEVBQXdCLEtBQXhCO0FBQ0E7QUFDRixhQUFLLENBQUw7QUFDRUMsbUJBQVNKLEtBQUtXLFFBQUwsQ0FBYyxDQUFkLEVBQWlCUCxNQUExQixDQURGLENBQ29DO0FBQ2xDRCxxQkFBV0MsT0FBT1ksU0FBUCxDQUFpQixDQUFqQixFQUFtQlosT0FBT2EsTUFBUCxHQUFjLENBQWpDLENBQVg7QUFDQWhCLG9CQUFVaUIsR0FBVixDQUFjZixRQUFkLEVBQXdCLElBQXhCO0FBQ0E7QUFDRixhQUFLLENBQUw7QUFDRUosY0FBSWEsS0FBSixDQUFVLEdBQVYsRUFERixDQUNrQjtBQUNoQjtBQUNGLGFBQUssQ0FBTDtBQUNFUCxnQkFBTUwsS0FBS1csUUFBTCxDQUFjLENBQWQsRUFBaUJQLE1BQXZCLENBREYsQ0FDaUM7QUFDL0IsY0FBS0osS0FBS1csUUFBTCxDQUFjLENBQWQsRUFBaUJGLFVBQWpCLENBQTRCQyxFQUE1QixLQUFtQyxDQUF4QyxFQUE0Q0wsT0FBTyxHQUFQO0FBQzVDLGdCQUFNYyxjQUFjbkIsS0FBS1csUUFBTCxDQUFjLENBQWQsQ0FBcEI7QUFDQSxnQkFBTVMsYUFBYUQsWUFBWVYsVUFBWixDQUF1QkMsRUFBdkIsS0FBOEIsQ0FBakQ7QUFDQSxjQUFJVyxXQUFXckIsS0FBS1csUUFBTCxDQUFjLENBQWQsQ0FBZjtBQUNBLGdCQUFNVyxVQUFVLEVBQWhCO0FBQ0EsaUJBQVFELFNBQVNaLFVBQVQsQ0FBb0JDLEVBQXBCLEtBQTJCLENBQW5DLEVBQXVDO0FBQ3JDO0FBQ0FZLG9CQUFRQyxJQUFSLENBQWFGLFNBQVNWLFFBQVQsQ0FBa0IsQ0FBbEIsQ0FBYjtBQUNBO0FBQ0FVLHVCQUFXQSxTQUFTVixRQUFULENBQWtCLENBQWxCLENBQVg7QUFDRDtBQUNELGNBQUksQ0FBQ1MsVUFBRCxJQUFlbkIsVUFBVXVCLEdBQVYsQ0FBY25CLEdBQWQsQ0FBbkIsRUFBdUM7QUFBRTtBQUN2QyxhQUFFQyxLQUFGLEVBQVVDLFNBQVYsSUFBd0JOLFVBQVVjLEdBQVYsQ0FBY1YsR0FBZCxDQUF4QjtBQUNBLGdCQUFJaUIsUUFBUUwsTUFBUixLQUFtQlgsS0FBdkIsRUFBOEIsTUFBTSxJQUFJbUIsS0FBSixDQUFVLHNCQUFWLENBQU47QUFDOUIzQixrQkFBTUMsR0FBTixFQUFXUSxTQUFYLEVBQXNCTixTQUF0QixFQUFpQyxDQUFFQyxJQUFGLEVBQVNvQixPQUFULENBQWpDO0FBQ0QsV0FKRCxNQUtLO0FBQ0h2QixnQkFBSWEsS0FBSixDQUFVUCxHQUFWO0FBQ0EsZ0JBQUllLFVBQUosRUFBZ0I7QUFDZHJCLGtCQUFJYSxLQUFKLENBQVUsR0FBVjtBQUNBZCxvQkFBTUMsR0FBTixFQUFXb0IsWUFBWVIsUUFBWixDQUFxQixDQUFyQixDQUFYLEVBQW9DVixTQUFwQyxFQUErQ0MsSUFBL0M7QUFDQUgsa0JBQUlhLEtBQUosQ0FBVSxHQUFWO0FBQ0Q7QUFDRCxpQkFBTSxNQUFNYyxPQUFaLElBQXVCSixPQUF2QixFQUFpQztBQUMvQnZCLGtCQUFJYSxLQUFKLENBQVUsR0FBVjtBQUNBZCxvQkFBTUMsR0FBTixFQUFXMkIsT0FBWCxFQUFvQnpCLFNBQXBCLEVBQStCQyxJQUEvQjtBQUNBSCxrQkFBSWEsS0FBSixDQUFVLEdBQVY7QUFDRDtBQUNGO0FBQ0Q7QUFDRixhQUFLLENBQUw7QUFDRTtBQUNBUCxnQkFBTUwsS0FBS1csUUFBTCxDQUFjLENBQWQsRUFBaUJQLE1BQXZCLENBRkYsQ0FFaUM7QUFDL0I7QUFDQUgsb0JBQVVpQixHQUFWLENBQWNiLEdBQWQsRUFBbUIsQ0FBQyxDQUFELEVBQUlMLEtBQUtXLFFBQUwsQ0FBYyxDQUFkLENBQUosQ0FBbkI7QUFDQTtBQUNBO0FBQ0YsYUFBSyxDQUFMO0FBQ0U7QUFDQWIsZ0JBQU9DLEdBQVAsRUFBYUMsS0FBS1csUUFBTCxDQUFjLENBQWQsQ0FBYixFQUFnQ1YsU0FBaEMsRUFBNENDLElBQTVDO0FBQ0E7QUFDRixhQUFLLENBQUw7QUFDRUgsY0FBSWEsS0FBSixDQUFVLEdBQVYsRUFERixDQUNrQjtBQUNoQmQsZ0JBQU9DLEdBQVAsRUFBYUMsS0FBS1csUUFBTCxDQUFjLENBQWQsQ0FBYixFQUFnQ1YsU0FBaEMsRUFBNENDLElBQTVDO0FBQ0FILGNBQUlhLEtBQUosQ0FBVSxHQUFWLEVBSEYsQ0FHa0I7QUFDaEI7QUFDRixhQUFLLEVBQUw7QUFDRWIsY0FBSWEsS0FBSixDQUFVLEdBQVYsRUFERixDQUNrQjtBQUNoQmQsZ0JBQU9DLEdBQVAsRUFBYUMsS0FBS1csUUFBTCxDQUFjLENBQWQsQ0FBYixFQUFnQ1YsU0FBaEMsRUFBNENDLElBQTVDO0FBQ0FILGNBQUlhLEtBQUosQ0FBVSxHQUFWLEVBSEYsQ0FHa0I7QUFDaEI7QUFDRixhQUFLLEVBQUw7QUFDRWIsY0FBSWEsS0FBSixDQUFVLEdBQVYsRUFERixDQUNrQjtBQUNoQjtBQUNGLGFBQUssRUFBTDtBQUNFO0FBQ0EsZ0JBQU1lLElBQUlDLFNBQVM1QixLQUFLVyxRQUFMLENBQWMsQ0FBZCxFQUFpQlAsTUFBakIsQ0FBd0JTLE1BQXhCLENBQStCLENBQS9CLENBQVQsRUFBNEMsRUFBNUMsSUFBa0QsQ0FBNUQsQ0FGRixDQUVpRTtBQUMvRCxjQUFLYyxLQUFLekIsS0FBSyxDQUFMLEVBQVFlLE1BQWxCLEVBQTJCLE1BQU0sSUFBSVEsS0FBSixDQUFVLGtDQUFWLENBQU47QUFDM0IsZ0JBQU1DLFVBQVV4QixLQUFLLENBQUwsRUFBUXlCLENBQVIsQ0FBaEIsQ0FKRixDQUk2QjtBQUMzQjdCLGdCQUFNQyxHQUFOLEVBQVcyQixPQUFYLEVBQW9CekIsU0FBcEIsRUFBK0JDLEtBQUssQ0FBTCxDQUEvQjtBQUNBO0FBN0ZHO0FBK0ZBO0FBQ0YsU0FBSyxDQUFMO0FBQ0UsWUFBTSxJQUFJdUIsS0FBSixDQUFVLG1EQUFWLENBQU47QUFDRixTQUFLLENBQUw7QUFDRSxjQUFTekIsS0FBS1MsVUFBTCxDQUFnQkMsRUFBekI7QUFDTCxhQUFLLENBQUw7QUFDRTtBQUNBTCxnQkFBTUwsS0FBS1csUUFBTCxDQUFjLENBQWQsRUFBaUJQLE1BQXZCLENBRkYsQ0FFaUM7QUFDL0I7QUFDQUUsa0JBQVEsQ0FBUjtBQUNBLGNBQUlOLEtBQUtXLFFBQUwsQ0FBYyxDQUFkLEVBQWlCRixVQUFqQixDQUE0QkMsRUFBNUIsS0FBbUMsQ0FBdkMsRUFBMEM7QUFDeEM7QUFDQUosb0JBQVFzQixTQUFTNUIsS0FBS1csUUFBTCxDQUFjLENBQWQsRUFBaUJBLFFBQWpCLENBQTBCLENBQTFCLEVBQTZCUCxNQUF0QyxFQUE4QyxFQUE5QyxDQUFSLENBRndDLENBRW1CO0FBQzNEO0FBQ0Q7QUFDRDtBQUNBSCxvQkFBVWlCLEdBQVYsQ0FBY2IsR0FBZCxFQUFtQixDQUFFQyxLQUFGLEVBQVVOLEtBQUtXLFFBQUwsQ0FBYyxDQUFkLENBQVYsQ0FBbkI7QUFDQTtBQUNBO0FBQ0YsYUFBSyxDQUFMO0FBQ0VOLGdCQUFNTCxLQUFLVyxRQUFMLENBQWMsQ0FBZCxFQUFpQlAsTUFBdkIsQ0FERixDQUNpQztBQUMvQkUsa0JBQVEsQ0FBUjtBQUNBLGNBQUlOLEtBQUtXLFFBQUwsQ0FBYyxDQUFkLEVBQWlCRixVQUFqQixDQUE0QkMsRUFBNUIsS0FBbUMsQ0FBdkMsRUFBMEM7QUFDeEM7QUFDQUosb0JBQVFzQixTQUFTNUIsS0FBS1csUUFBTCxDQUFjLENBQWQsRUFBaUJBLFFBQWpCLENBQTBCLENBQTFCLEVBQTZCUCxNQUF0QyxFQUE4QyxFQUE5QyxDQUFSLENBRndDLENBRW1CO0FBQzNEO0FBQ0Q7QUFDRDtBQUNBSCxvQkFBVWlCLEdBQVYsQ0FBY2IsR0FBZCxFQUFtQixDQUFFQyxLQUFGLEVBQVVOLEtBQUtXLFFBQUwsQ0FBYyxDQUFkLENBQVYsQ0FBbkI7QUFDQTtBQUNBO0FBQ0YsYUFBSyxDQUFMO0FBQ0U7QUFDQU4sZ0JBQU1MLEtBQUtXLFFBQUwsQ0FBYyxDQUFkLEVBQWlCUCxNQUF2QixDQUZGLENBRWlDO0FBQy9CO0FBQ0FFLGtCQUFRLENBQVI7QUFDQSxjQUFJTixLQUFLVyxRQUFMLENBQWMsQ0FBZCxFQUFpQkYsVUFBakIsQ0FBNEJDLEVBQTVCLEtBQW1DLENBQXZDLEVBQTBDO0FBQ3hDO0FBQ0FKLG9CQUFRc0IsU0FBUzVCLEtBQUtXLFFBQUwsQ0FBYyxDQUFkLEVBQWlCQSxRQUFqQixDQUEwQixDQUExQixFQUE2QlAsTUFBdEMsRUFBOEMsRUFBOUMsQ0FBUixDQUZ3QyxDQUVtQjtBQUMzRDtBQUNEO0FBQ0Q7QUFDQUgsb0JBQVVpQixHQUFWLENBQWNiLEdBQWQsRUFBbUIsQ0FBRUMsS0FBRixFQUFTTixLQUFLVyxRQUFMLENBQWMsQ0FBZCxDQUFULENBQW5CO0FBQ0E7QUFDQTtBQXhDRztBQTBDQTtBQUNGLFNBQUssQ0FBTDtBQUNFLFlBQU0sSUFBSWMsS0FBSixDQUFVLG1EQUFWLENBQU47QUFDRixTQUFLLENBQUw7QUFDRSxZQUFNLElBQUlBLEtBQUosQ0FBVSxtREFBVixDQUFOO0FBQ0YsU0FBSyxDQUFMO0FBQ0UsWUFBTSxJQUFJQSxLQUFKLENBQVUsbURBQVYsQ0FBTjtBQUNGLFNBQUssQ0FBTDtBQUNFLFlBQU0sSUFBSUEsS0FBSixDQUFVLG1EQUFWLENBQU47QUF2Sko7QUEwSkQiLCJmaWxlIjoic2hha2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgZnVuY3Rpb24gc2hha2UgKCBvdXQgLCB0cmVlICwgdmFyaWFibGVzICwgYXJncyApIHtcblxuICBsZXQgdmFyaWFibGUgLCBidWZmZXIgLCBjbWQgLCBuYXJncyAsIGV4cGFuZHN0byA7XG5cbiAgd2hpbGUgKCB0cmVlLm5vbnRlcm1pbmFsID09PSAwICkge1xuICAgIC8vIGVsaW1pbmF0ZSBleHBlbnNpdmUgdGFpbC1yZWN1cnNpb25cbiAgICBpZiAoIHRyZWUucHJvZHVjdGlvbi5pZCA9PT0gMSApIHJldHVybiA7XG4gICAgc2hha2UoIG91dCAsIHRyZWUuY2hpbGRyZW5bMF0gLCB2YXJpYWJsZXMgLCBhcmdzICkgOyAvLyAxXG4gICAgdHJlZSA9IHRyZWUuY2hpbGRyZW5bMV07IC8vIDBcbiAgfVxuXG4gIHN3aXRjaCAoIHRyZWUubm9udGVybWluYWwgKSB7XG4gICAgY2FzZSAxOlxuICAgICAgc3dpdGNoICggdHJlZS5wcm9kdWN0aW9uLmlkICkge1xuXHRjYXNlIDA6XG5cdCAgb3V0LndyaXRlKHRyZWUuY2hpbGRyZW5bMF0uYnVmZmVyKTsgLy8gdGV4dFxuXHQgIGJyZWFrO1xuXHRjYXNlIDE6XG5cdCAgLy8gbmV3aWZcblx0ICAvLyBpZmNtZFxuXHQgIGJyZWFrO1xuXHRjYXNlIDI6XG5cdCAgdmFyaWFibGUgPSB0cmVlLmNoaWxkcmVuWzBdLmJ1ZmZlci5zdWJzdHIoMyk7IC8vIGlmY21kXG5cdCAgY29uc3QgZmxhZyA9IHZhcmlhYmxlcy5nZXQodmFyaWFibGUpO1xuXHQgIGlmIChmbGFnKSBzaGFrZShvdXQsIHRyZWUuY2hpbGRyZW5bMV0gLCB2YXJpYWJsZXMgLCBhcmdzKSA7XG5cdCAgZWxzZSBpZiAoIHRyZWUuY2hpbGRyZW5bMl0ucHJvZHVjdGlvbi5pZCA9PT0gMCApIHtcblx0ICAgIC8vIGVsc2Vcblx0ICAgIHNoYWtlKG91dCwgdHJlZS5jaGlsZHJlblsyXS5jaGlsZHJlblsxXSAsIHZhcmlhYmxlcyAsIGFyZ3MpIDtcblx0ICB9XG5cdCAgLy8gZmlcblx0ICBicmVhaztcblx0Y2FzZSAzOlxuXHQgIGJ1ZmZlciA9IHRyZWUuY2hpbGRyZW5bMF0uYnVmZmVyOyAvLyBmYWxzZWNtZFxuXHQgIHZhcmlhYmxlID0gYnVmZmVyLnN1YnN0cmluZygxLGJ1ZmZlci5sZW5ndGgtNSk7XG5cdCAgdmFyaWFibGVzLnNldCh2YXJpYWJsZSwgZmFsc2UpO1xuXHQgIGJyZWFrO1xuXHRjYXNlIDQ6XG5cdCAgYnVmZmVyID0gdHJlZS5jaGlsZHJlblswXS5idWZmZXI7IC8vIHRydWVjbWRcblx0ICB2YXJpYWJsZSA9IGJ1ZmZlci5zdWJzdHJpbmcoMSxidWZmZXIubGVuZ3RoLTQpO1xuXHQgIHZhcmlhYmxlcy5zZXQodmFyaWFibGUsIHRydWUpO1xuXHQgIGJyZWFrO1xuXHRjYXNlIDU6XG5cdCAgb3V0LndyaXRlKCclJyk7IC8vIGNvbW1lbnRcblx0ICBicmVhaztcblx0Y2FzZSA2OlxuXHQgIGNtZCA9IHRyZWUuY2hpbGRyZW5bMF0uYnVmZmVyOyAvLyBvdGhlcmNtZFxuXHQgIGlmICggdHJlZS5jaGlsZHJlblsxXS5wcm9kdWN0aW9uLmlkID09PSAwICkgY21kICs9ICcqJztcblx0ICBjb25zdCBvcHRhcmdzbm9kZSA9IHRyZWUuY2hpbGRyZW5bMl07XG5cdCAgY29uc3QgaGFzb3B0YXJncyA9IG9wdGFyZ3Nub2RlLnByb2R1Y3Rpb24uaWQgPT09IDAgO1xuXHQgIGxldCBhcmdzbm9kZSA9IHRyZWUuY2hpbGRyZW5bM10gO1xuXHQgIGNvbnN0IGNtZGFyZ3MgPSBbXTtcblx0ICB3aGlsZSAoIGFyZ3Nub2RlLnByb2R1Y3Rpb24uaWQgPT09IDAgKSB7XG5cdCAgICAvLyB7XG5cdCAgICBjbWRhcmdzLnB1c2goYXJnc25vZGUuY2hpbGRyZW5bMV0pIDtcblx0ICAgIC8vIH1cblx0ICAgIGFyZ3Nub2RlID0gYXJnc25vZGUuY2hpbGRyZW5bM107XG5cdCAgfVxuXHQgIGlmICghaGFzb3B0YXJncyAmJiB2YXJpYWJsZXMuaGFzKGNtZCkpIHsgLy8gdG9vIGhhcmQgdG8gcGFyc2Ugb3B0IGFyZ3MgY3VycmVudGx5XG5cdCAgICBbIG5hcmdzICwgZXhwYW5kc3RvIF0gPSB2YXJpYWJsZXMuZ2V0KGNtZCkgO1xuXHQgICAgaWYgKGNtZGFyZ3MubGVuZ3RoICE9PSBuYXJncykgdGhyb3cgbmV3IEVycm9yKCduYXJncyBkb2VzIG5vdCBtYXRjaCcpIDtcblx0ICAgIHNoYWtlKG91dCwgZXhwYW5kc3RvLCB2YXJpYWJsZXMsIFsgYXJncyAsIGNtZGFyZ3MgXSApO1xuXHQgIH1cblx0ICBlbHNlIHtcblx0ICAgIG91dC53cml0ZShjbWQpO1xuXHQgICAgaWYgKGhhc29wdGFyZ3MpIHtcblx0ICAgICAgb3V0LndyaXRlKCdbJyk7XG5cdCAgICAgIHNoYWtlKG91dCwgb3B0YXJnc25vZGUuY2hpbGRyZW5bMV0sIHZhcmlhYmxlcywgYXJncyk7XG5cdCAgICAgIG91dC53cml0ZSgnXScpO1xuXHQgICAgfVxuXHQgICAgZm9yICggY29uc3Qgc3VidHJlZSBvZiBjbWRhcmdzICkge1xuXHQgICAgICBvdXQud3JpdGUoJ3snKTtcblx0ICAgICAgc2hha2Uob3V0LCBzdWJ0cmVlLCB2YXJpYWJsZXMsIGFyZ3MpO1xuXHQgICAgICBvdXQud3JpdGUoJ30nKTtcblx0ICAgIH1cblx0ICB9XG5cdCAgYnJlYWs7XG5cdGNhc2UgNzpcblx0ICAvLyBkZWZcblx0ICBjbWQgPSB0cmVlLmNoaWxkcmVuWzFdLmJ1ZmZlcjsgLy8gb3RoZXJjbWRcblx0ICAvLyB7XG5cdCAgdmFyaWFibGVzLnNldChjbWQsIFswLCB0cmVlLmNoaWxkcmVuWzNdXSk7XG5cdCAgLy8gfVxuXHQgIGJyZWFrO1xuXHRjYXNlIDg6XG5cdCAgLy8gbmV3Y29tbWFuZFxuXHQgIHNoYWtlKCBvdXQgLCB0cmVlLmNoaWxkcmVuWzFdICwgdmFyaWFibGVzICwgYXJncykgO1xuXHQgIGJyZWFrO1xuXHRjYXNlIDk6XG5cdCAgb3V0LndyaXRlKCd7Jyk7IC8vIHtcblx0ICBzaGFrZSggb3V0ICwgdHJlZS5jaGlsZHJlblsxXSAsIHZhcmlhYmxlcyAsIGFyZ3MpIDtcblx0ICBvdXQud3JpdGUoJ30nKTsgLy8gfVxuXHQgIGJyZWFrO1xuXHRjYXNlIDEwOlxuXHQgIG91dC53cml0ZSgnWycpOyAvLyBbXG5cdCAgc2hha2UoIG91dCAsIHRyZWUuY2hpbGRyZW5bMV0gLCB2YXJpYWJsZXMgLCBhcmdzKSA7XG5cdCAgb3V0LndyaXRlKCddJyk7IC8vIF1cblx0ICBicmVhaztcblx0Y2FzZSAxMTpcblx0ICBvdXQud3JpdGUoJyonKTsgLy8gKlxuXHQgIGJyZWFrO1xuXHRjYXNlIDEyOlxuXHQgIC8vdGhyb3cgbmV3IEVycm9yKCdTaG91bGQgbmV2ZXIgcmVhY2ggY2FzZSAxLjEyIGJlY2F1c2UgaGFuZGxlZCBiZWZvcmUuJyk7XG5cdCAgY29uc3QgaSA9IHBhcnNlSW50KHRyZWUuY2hpbGRyZW5bMF0uYnVmZmVyLnN1YnN0cigxKSwgMTApIC0gMTsgLy8gYXJnXG5cdCAgaWYgKCBpID49IGFyZ3NbMV0ubGVuZ3RoICkgdGhyb3cgbmV3IEVycm9yKCdzaGFrZSAxLjEyOiBub3QgZW5vdWdoIGFyZ3VtZW50cycpIDtcblx0ICBjb25zdCBzdWJ0cmVlID0gYXJnc1sxXVtpXSAvLyBhcmdcblx0ICBzaGFrZShvdXQsIHN1YnRyZWUsIHZhcmlhYmxlcywgYXJnc1swXSk7XG5cdCAgYnJlYWs7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlIDI6XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Nob3VsZCBuZXZlciByZWFjaCBjYXNlIDIgYmVjYXVzZSBoYW5kbGVkIGJlZm9yZS4nKTtcbiAgICBjYXNlIDM6XG4gICAgICBzd2l0Y2ggKCB0cmVlLnByb2R1Y3Rpb24uaWQgKSB7XG5cdGNhc2UgMDpcblx0ICAvLyB7XG5cdCAgY21kID0gdHJlZS5jaGlsZHJlblsxXS5idWZmZXI7IC8vIG90aGVyY21kXG5cdCAgLy8gfVxuXHQgIG5hcmdzID0gMDtcblx0ICBpZiAodHJlZS5jaGlsZHJlblszXS5wcm9kdWN0aW9uLmlkID09PSAwKSB7XG5cdCAgICAvLyBbXG5cdCAgICBuYXJncyA9IHBhcnNlSW50KHRyZWUuY2hpbGRyZW5bM10uY2hpbGRyZW5bMV0uYnVmZmVyLCAxMCk7IC8vIHRleHRcblx0ICAgIC8vIF1cblx0ICB9XG5cdCAgLy8ge1xuXHQgIHZhcmlhYmxlcy5zZXQoY21kLCBbIG5hcmdzICwgdHJlZS5jaGlsZHJlbls1XSBdKTtcblx0ICAvLyB9XG5cdCAgYnJlYWs7XG5cdGNhc2UgMTpcblx0ICBjbWQgPSB0cmVlLmNoaWxkcmVuWzBdLmJ1ZmZlcjsgLy8gb3RoZXJjbWRcblx0ICBuYXJncyA9IDA7XG5cdCAgaWYgKHRyZWUuY2hpbGRyZW5bMV0ucHJvZHVjdGlvbi5pZCA9PT0gMCkge1xuXHQgICAgLy8gW1xuXHQgICAgbmFyZ3MgPSBwYXJzZUludCh0cmVlLmNoaWxkcmVuWzFdLmNoaWxkcmVuWzFdLmJ1ZmZlciwgMTApOyAvLyB0ZXh0XG5cdCAgICAvLyBdXG5cdCAgfVxuXHQgIC8vIHtcblx0ICB2YXJpYWJsZXMuc2V0KGNtZCwgWyBuYXJncyAsIHRyZWUuY2hpbGRyZW5bM10gXSk7XG5cdCAgLy8gfVxuXHQgIGJyZWFrO1xuXHRjYXNlIDI6XG5cdCAgLy8gKlxuXHQgIGNtZCA9IHRyZWUuY2hpbGRyZW5bMV0uYnVmZmVyOyAvLyBvdGhlcmNtZFxuXHQgIC8vIGRvIG5vdCBrbm93IHdoYXQgdG8gZG8gd2l0aCAnKicgYXQgdGhlIG1vbWVudFxuXHQgIG5hcmdzID0gMDtcblx0ICBpZiAodHJlZS5jaGlsZHJlblsyXS5wcm9kdWN0aW9uLmlkID09PSAwKSB7XG5cdCAgICAvLyBbXG5cdCAgICBuYXJncyA9IHBhcnNlSW50KHRyZWUuY2hpbGRyZW5bMl0uY2hpbGRyZW5bMV0uYnVmZmVyLCAxMCk7IC8vIHRleHRcblx0ICAgIC8vIF1cblx0ICB9XG5cdCAgLy8ge1xuXHQgIHZhcmlhYmxlcy5zZXQoY21kLCBbIG5hcmdzLCB0cmVlLmNoaWxkcmVuWzRdXSk7XG5cdCAgLy8gfVxuXHQgIGJyZWFrO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSA0OlxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTaG91bGQgbmV2ZXIgcmVhY2ggY2FzZSA0IGJlY2F1c2UgaGFuZGxlZCBiZWZvcmUuJyk7XG4gICAgY2FzZSA1OlxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTaG91bGQgbmV2ZXIgcmVhY2ggY2FzZSA1IGJlY2F1c2UgaGFuZGxlZCBiZWZvcmUuJyk7XG4gICAgY2FzZSA2OlxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTaG91bGQgbmV2ZXIgcmVhY2ggY2FzZSA2IGJlY2F1c2UgaGFuZGxlZCBiZWZvcmUuJyk7XG4gICAgY2FzZSA3OlxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTaG91bGQgbmV2ZXIgcmVhY2ggY2FzZSA3IGJlY2F1c2UgaGFuZGxlZCBiZWZvcmUuJyk7XG4gIH1cblxufVxuIl19