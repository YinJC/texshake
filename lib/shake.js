'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.shake = undefined;

var _jsItertools = require('@aureooms/js-itertools');

var _jsGrammar = require('@aureooms/js-grammar');

const empty = {
  'type': 'node',
  'nonterminal': 'empty',
  'production': 'main',
  'children': []
};

const err = (nonterminal, production) => () => {
  throw new Error(`${nonterminal}.${production} should have been handled before`);
};

const t = _jsGrammar.ast.transform;
const m = (children, match, ctx) => _jsGrammar.ast.cmap(child => t(child, match, ctx), children);

const recurse = (nonterminal, production) => (tree, match, ctx) => ({
  "type": "node",
  nonterminal,
  production,
  "children": m(tree.children, match, ctx)
});

const shake = exports.shake = {

  "anything": {
    "starts-with-othercmd": recurse('anything', 'starts-with-othercmd'),
    "starts-with-*": recurse('anything', 'starts-with-*'),
    "starts-with-[": recurse('anything', 'starts-with-['),
    "starts-with-]": recurse('anything', 'starts-with-]'),
    "starts-with-a-group": recurse('anything', 'starts-with-a-group'),
    "starts-with-something-else": recurse('anything', 'starts-with-something-else'),
    "end": () => empty
  },

  "anything-but-]": {
    "starts-with-othercmd": recurse('anything-but-]', 'starts-with-othercmd'),
    "starts-with-*": recurse('anything', 'starts-with-*'),
    "starts-with-[": recurse('anything', 'starts-with-['),
    "starts-with-a-group": recurse('anything-but-]', 'starts-with-a-group'),
    "starts-with-something-else": recurse('anything-but-]', 'starts-with-something-else'),
    "end": () => empty
  },

  "group": {
    "group": (tree, match, ctx) => {
      const [_open, anything, _close] = tree.children;
      return {
        "type": "node",
        "nonterminal": "group",
        "production": "group",
        "children": (0, _jsItertools.chain)([[_open], m([anything], match, ctx), [_close]])
      };
    }
  },

  "optgroup": {
    "group": (tree, match, ctx) => {
      const [_open, anything, _close] = tree.children;
      return {
        "type": "node",
        "nonterminal": "optgroup",
        "production": "group",
        "children": (0, _jsItertools.chain)([[_open], m([anything], match, ctx), [_close]])
      };
    }
  },

  "othercmd": {

    "othercmd": (tree, match, ctx) => {
      const [othercmd, optstar, args] = tree.children;
      let cmd = othercmd.buffer;
      if (optstar.production === 'yes') cmd += '*';
      const cmdargs = [];
      let arg_i = args;
      while (arg_i.production === 'normal') {
        const [group, argstail] = arg_i.children;
        const [_open, arg, _close] = group.children;
        cmdargs.push(arg);
        arg_i = argstail;
      }
      const hasoptargs = arg_i.production === 'optional';
      if (!hasoptargs && ctx.variables.has(cmd)) {
        // too hard to parse opt args currently
        const [nargs, expandsto] = ctx.variables.get(cmd);
        if (cmdargs.length !== nargs) throw new Error(`Command ${cmd} is defined with ${nargs} arguments but ${cmdargs.length} were given.`);
        return t(expandsto, match, { variables: ctx.variables, args: [ctx.args, cmdargs] });
      } else return {
        'type': 'node',
        'nonterminal': 'othercmd',
        'production': 'othercmd',
        'children': (0, _jsItertools.chain)([[othercmd, optstar], m([args], match, ctx)])
      };
    }

  },

  "*": {
    "*": tree => tree
  },

  "[": {
    "[": tree => tree
  },

  "]": {
    "]": tree => tree
  },

  "something-else": {

    "text": tree => tree,

    "newif": () => empty,

    "ifcmd": (tree, match, ctx) => {

      const [ifcmd, block1, endif] = tree.children;
      const variable = ifcmd.buffer.substr(3);

      if (ctx.variables.has(variable)) {
        const flag = ctx.variables.get(variable);
        if (flag) return t(block1, match, ctx);else if (endif.production === "elsefi") {
          const [_else, block2, _fi] = endif.children;
          return t(block2, match, ctx);
        } else return empty;
      }

      return {
        'type': 'node',
        'nonterminal': 'something-else',
        'production': 'ifcmd',
        'children': (0, _jsItertools.chain)([[ifcmd], m([block1, endif], match, ctx)])
      };
    },

    "falsecmd": (tree, _, ctx) => {
      const [falsecmd] = tree.children;
      const buffer = falsecmd.buffer;
      const variable = buffer.substring(1, buffer.length - 5);
      ctx.variables.set(variable, false);
      return empty;
    },

    "truecmd": (tree, _, ctx) => {
      const [truecmd] = tree.children;
      const buffer = truecmd.buffer;
      const variable = buffer.substring(1, buffer.length - 4);
      ctx.variables.set(variable, true);
      return empty;
    },

    "comment": () => ({
      'type': 'leaf',
      'terminal': 'comment',
      'buffer': '%'
    }),

    "def": (tree, match, { variables }) => {
      const [def, othercmd, _2, anything, _3] = tree.children;
      const cmd = othercmd.buffer;
      variables.set(cmd, [0, _jsGrammar.ast.materialize(anything)]);
      return empty;
    },

    "newcommand": (tree, match, ctx) => {
      const [newcommand, cmddef] = tree.children;
      return t(cmddef, match, ctx);
    },

    " ": tree => tree,
    "\t": tree => tree,
    "\n": tree => tree,

    "arg": (tree, match, { args, variables }) => {
      const [arg] = tree.children;
      const i = parseInt(arg.buffer.substr(1), 10) - 1; // #arg
      if (i >= args[1].length) throw new Error(`Requesting ${arg} but only got ${args[1].length} arguments.`);
      const subtree = args[1][i]; // arg
      return t(subtree, match, { args: args[0], variables });
    },

    "$": tree => tree,

    "math": (tree, match, ctx) => {
      const [_open, anything, _close] = tree.children;
      return {
        "type": "node",
        "nonterminal": 'something-else',
        "production": "math",
        "children": (0, _jsItertools.chain)([[_open], m([anything], match, ctx), [_close]])
      };
    },

    "mathenv": (tree, match, ctx) => {
      const [_open, anything, _close] = tree.children;
      return {
        "type": "node",
        "nonterminal": 'something-else',
        "production": "mathenv",
        "children": (0, _jsItertools.chain)([[_open], m([anything], match, ctx), [_close]])
      };
    }

  },

  "endif": {

    "elsefi": (tree, match, ctx) => {
      const [_else, anything, _fi] = tree.children;
      return {
        "type": "node",
        "nonterminal": "endif",
        "production": "elsefi",
        "children": (0, _jsItertools.chain)([[_else], m([anything], match, ctx), [_fi]])
      };
    },

    "fi": () => ({ // tree => tree ?
      "type": "leaf",
      "terminal": "text",
      "buffer": '\\fi'
    })

  },

  "cmddef": {

    "{cmd}[x]{anything}": (tree, _, { variables }) => {
      const [_0, othercmd, _1, cmddefargs, _2, anything, _3] = tree.children;
      const cmd = othercmd.buffer;
      let nargs = 0;
      if (cmddefargs.production === 'yes') {
        const [_4, text, _5] = cmddefargs.children;
        nargs = parseInt(text.buffer, 10);
      }
      variables.set(cmd, [nargs, anything]);
      return empty;
    },

    "cmd[x]{anything}": (tree, _, { variables }) => {
      const [othercmd, cmddefargs, _2, anything, _3] = tree.children;
      const cmd = othercmd.buffer;
      let nargs = 0;
      if (cmddefargs.production === 'yes') {
        const [_4, text, _5] = cmddefargs.children;
        nargs = parseInt(text.buffer, 10);
      }
      variables.set(cmd, [nargs, anything]);
      return empty;
    },

    "*cmd[x]{anything}": (tree, _, { variables }) => {
      // do not know what to do with '*' at the moment
      const [_1, othercmd, cmddefargs, _2, anything, _3] = tree.children;
      const cmd = othercmd.buffer;
      let nargs = 0;
      if (cmddefargs.production === 'yes') {
        const [_4, text, _5] = cmddefargs.children;
        nargs = parseInt(text.buffer, 10);
      }
      variables.set(cmd, [nargs, anything]);
      return empty;
    }

  },

  "cmddefargs": {
    "yes": err("cmddefargs", "yes"),
    "no": err("cmddefargs", "no")
  },

  "cmd*": {
    "yes": err("cmd*", "yes"),
    "no": err("cmd*", "no")
  },

  "cmdargs": {
    "normal": recurse('cmdargs', 'normal'),
    "optional": recurse('cmdargs', 'optional'),
    "end": () => empty
  },

  "cmdafter": {
    "othercmd": recurse('cmdafter', 'othercmd'),
    "something-else-then-anything": recurse('cmdafter', 'something-else-then-anything'),
    "]-then-anything": recurse('cmdafter', ']-then-anything'),
    "nothing": () => empty
  },

  "cmdafter-but-not-]": {
    "othercmd": recurse('cmdafter-but-not-]', 'othercmd'),
    "something-else-then-anything": recurse('cmdafter-but-not-]', 'something-else-then-anything'),
    "nothing": () => empty
  }

};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zaGFrZS5qcyJdLCJuYW1lcyI6WyJlbXB0eSIsImVyciIsIm5vbnRlcm1pbmFsIiwicHJvZHVjdGlvbiIsIkVycm9yIiwidCIsImFzdCIsInRyYW5zZm9ybSIsIm0iLCJjaGlsZHJlbiIsIm1hdGNoIiwiY3R4IiwiY21hcCIsImNoaWxkIiwicmVjdXJzZSIsInRyZWUiLCJzaGFrZSIsIl9vcGVuIiwiYW55dGhpbmciLCJfY2xvc2UiLCJvdGhlcmNtZCIsIm9wdHN0YXIiLCJhcmdzIiwiY21kIiwiYnVmZmVyIiwiY21kYXJncyIsImFyZ19pIiwiZ3JvdXAiLCJhcmdzdGFpbCIsImFyZyIsInB1c2giLCJoYXNvcHRhcmdzIiwidmFyaWFibGVzIiwiaGFzIiwibmFyZ3MiLCJleHBhbmRzdG8iLCJnZXQiLCJsZW5ndGgiLCJpZmNtZCIsImJsb2NrMSIsImVuZGlmIiwidmFyaWFibGUiLCJzdWJzdHIiLCJmbGFnIiwiX2Vsc2UiLCJibG9jazIiLCJfZmkiLCJfIiwiZmFsc2VjbWQiLCJzdWJzdHJpbmciLCJzZXQiLCJ0cnVlY21kIiwiZGVmIiwiXzIiLCJfMyIsIm1hdGVyaWFsaXplIiwibmV3Y29tbWFuZCIsImNtZGRlZiIsImkiLCJwYXJzZUludCIsInN1YnRyZWUiLCJfMCIsIl8xIiwiY21kZGVmYXJncyIsIl80IiwidGV4dCIsIl81Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUEsTUFBTUEsUUFBUTtBQUNaLFVBQVMsTUFERztBQUVaLGlCQUFnQixPQUZKO0FBR1osZ0JBQWUsTUFISDtBQUlaLGNBQWE7QUFKRCxDQUFkOztBQU9BLE1BQU1DLE1BQU0sQ0FBRUMsV0FBRixFQUFnQkMsVUFBaEIsS0FBZ0MsTUFBTTtBQUNoRCxRQUFNLElBQUlDLEtBQUosQ0FBVyxHQUFFRixXQUFZLElBQUdDLFVBQVcsa0NBQXZDLENBQU47QUFDRCxDQUZEOztBQUlBLE1BQU1FLElBQUlDLGVBQUlDLFNBQWQ7QUFDQSxNQUFNQyxJQUFJLENBQUVDLFFBQUYsRUFBYUMsS0FBYixFQUFxQkMsR0FBckIsS0FBOEJMLGVBQUlNLElBQUosQ0FBVUMsU0FBU1IsRUFBR1EsS0FBSCxFQUFXSCxLQUFYLEVBQW1CQyxHQUFuQixDQUFuQixFQUE4Q0YsUUFBOUMsQ0FBeEM7O0FBRUEsTUFBTUssVUFBVSxDQUFFWixXQUFGLEVBQWdCQyxVQUFoQixLQUFnQyxDQUFFWSxJQUFGLEVBQVNMLEtBQVQsRUFBaUJDLEdBQWpCLE1BQTJCO0FBQ3pFLFVBQVMsTUFEZ0U7QUFFekVULGFBRnlFO0FBR3pFQyxZQUh5RTtBQUl6RSxjQUFhSyxFQUFHTyxLQUFLTixRQUFSLEVBQW1CQyxLQUFuQixFQUEyQkMsR0FBM0I7QUFKNEQsQ0FBM0IsQ0FBaEQ7O0FBUU8sTUFBTUssd0JBQVE7O0FBRW5CLGNBQWE7QUFDWCw0QkFBeUJGLFFBQVMsVUFBVCxFQUFzQixzQkFBdEIsQ0FEZDtBQUVYLHFCQUFrQkEsUUFBUyxVQUFULEVBQXNCLGVBQXRCLENBRlA7QUFHWCxxQkFBa0JBLFFBQVMsVUFBVCxFQUFzQixlQUF0QixDQUhQO0FBSVgscUJBQWtCQSxRQUFTLFVBQVQsRUFBc0IsZUFBdEIsQ0FKUDtBQUtYLDJCQUF3QkEsUUFBUyxVQUFULEVBQXNCLHFCQUF0QixDQUxiO0FBTVgsa0NBQStCQSxRQUFTLFVBQVQsRUFBc0IsNEJBQXRCLENBTnBCO0FBT1gsV0FBUSxNQUFNZDtBQVBILEdBRk07O0FBWW5CLG9CQUFtQjtBQUNqQiw0QkFBeUJjLFFBQVMsZ0JBQVQsRUFBNEIsc0JBQTVCLENBRFI7QUFFakIscUJBQWtCQSxRQUFTLFVBQVQsRUFBc0IsZUFBdEIsQ0FGRDtBQUdqQixxQkFBa0JBLFFBQVMsVUFBVCxFQUFzQixlQUF0QixDQUhEO0FBSWpCLDJCQUF3QkEsUUFBUyxnQkFBVCxFQUE0QixxQkFBNUIsQ0FKUDtBQUtqQixrQ0FBK0JBLFFBQVMsZ0JBQVQsRUFBNEIsNEJBQTVCLENBTGQ7QUFNakIsV0FBUSxNQUFNZDtBQU5HLEdBWkE7O0FBcUJuQixXQUFVO0FBQ1IsYUFBVSxDQUFFZSxJQUFGLEVBQVNMLEtBQVQsRUFBaUJDLEdBQWpCLEtBQTBCO0FBQ2xDLFlBQU0sQ0FBRU0sS0FBRixFQUFVQyxRQUFWLEVBQXFCQyxNQUFyQixJQUFnQ0osS0FBS04sUUFBM0M7QUFDQSxhQUFPO0FBQ1osZ0JBQVMsTUFERztBQUVaLHVCQUFnQixPQUZKO0FBR1osc0JBQWUsT0FISDtBQUlaLG9CQUFhLHdCQUFPLENBQUUsQ0FBRVEsS0FBRixDQUFGLEVBQWNULEVBQUcsQ0FBRVUsUUFBRixDQUFILEVBQWtCUixLQUFsQixFQUEwQkMsR0FBMUIsQ0FBZCxFQUFnRCxDQUFFUSxNQUFGLENBQWhELENBQVA7QUFKRCxPQUFQO0FBTUQ7QUFUTyxHQXJCUzs7QUFpQ25CLGNBQWE7QUFDWCxhQUFVLENBQUVKLElBQUYsRUFBU0wsS0FBVCxFQUFpQkMsR0FBakIsS0FBMEI7QUFDbEMsWUFBTSxDQUFFTSxLQUFGLEVBQVVDLFFBQVYsRUFBcUJDLE1BQXJCLElBQWdDSixLQUFLTixRQUEzQztBQUNBLGFBQU87QUFDWixnQkFBUyxNQURHO0FBRVosdUJBQWdCLFVBRko7QUFHWixzQkFBZSxPQUhIO0FBSVosb0JBQWEsd0JBQU8sQ0FBRSxDQUFFUSxLQUFGLENBQUYsRUFBY1QsRUFBRyxDQUFFVSxRQUFGLENBQUgsRUFBa0JSLEtBQWxCLEVBQTBCQyxHQUExQixDQUFkLEVBQWdELENBQUVRLE1BQUYsQ0FBaEQsQ0FBUDtBQUpELE9BQVA7QUFNRDtBQVRVLEdBakNNOztBQTZDbkIsY0FBYTs7QUFFWCxnQkFBWSxDQUFFSixJQUFGLEVBQVNMLEtBQVQsRUFBaUJDLEdBQWpCLEtBQTBCO0FBQ3BDLFlBQU0sQ0FBRVMsUUFBRixFQUFhQyxPQUFiLEVBQXVCQyxJQUF2QixJQUFnQ1AsS0FBS04sUUFBM0M7QUFDQSxVQUFJYyxNQUFNSCxTQUFTSSxNQUFuQjtBQUNBLFVBQUtILFFBQVFsQixVQUFSLEtBQXVCLEtBQTVCLEVBQW9Db0IsT0FBTyxHQUFQO0FBQ3BDLFlBQU1FLFVBQVUsRUFBaEI7QUFDQSxVQUFJQyxRQUFRSixJQUFaO0FBQ0EsYUFBUUksTUFBTXZCLFVBQU4sS0FBcUIsUUFBN0IsRUFBd0M7QUFDN0MsY0FBTSxDQUFFd0IsS0FBRixFQUFVQyxRQUFWLElBQXVCRixNQUFNakIsUUFBbkM7QUFDQSxjQUFNLENBQUVRLEtBQUYsRUFBVVksR0FBVixFQUFnQlYsTUFBaEIsSUFBMkJRLE1BQU1sQixRQUF2QztBQUNBZ0IsZ0JBQVFLLElBQVIsQ0FBYUQsR0FBYjtBQUNBSCxnQkFBUUUsUUFBUjtBQUNNO0FBQ0QsWUFBTUcsYUFBYUwsTUFBTXZCLFVBQU4sS0FBcUIsVUFBeEM7QUFDQSxVQUFJLENBQUM0QixVQUFELElBQWVwQixJQUFJcUIsU0FBSixDQUFjQyxHQUFkLENBQWtCVixHQUFsQixDQUFuQixFQUEyQztBQUNoRDtBQUNBLGNBQU0sQ0FBRVcsS0FBRixFQUFVQyxTQUFWLElBQXdCeEIsSUFBSXFCLFNBQUosQ0FBY0ksR0FBZCxDQUFrQmIsR0FBbEIsQ0FBOUI7QUFDQSxZQUFJRSxRQUFRWSxNQUFSLEtBQW1CSCxLQUF2QixFQUE4QixNQUFNLElBQUk5QixLQUFKLENBQVcsV0FBVW1CLEdBQUksb0JBQW1CVyxLQUFNLGtCQUFpQlQsUUFBUVksTUFBTyxjQUFsRixDQUFOO0FBQzlCLGVBQU9oQyxFQUFHOEIsU0FBSCxFQUFlekIsS0FBZixFQUF1QixFQUFFc0IsV0FBV3JCLElBQUlxQixTQUFqQixFQUE2QlYsTUFBTSxDQUFFWCxJQUFJVyxJQUFOLEVBQWFHLE9BQWIsQ0FBbkMsRUFBdkIsQ0FBUDtBQUNNLE9BTEQsTUFNSyxPQUFPO0FBQ2pCLGdCQUFTLE1BRFE7QUFFakIsdUJBQWdCLFVBRkM7QUFHakIsc0JBQWUsVUFIRTtBQUlqQixvQkFBYSx3QkFBTyxDQUFFLENBQUVMLFFBQUYsRUFBYUMsT0FBYixDQUFGLEVBQTJCYixFQUFFLENBQUNjLElBQUQsQ0FBRixFQUFVWixLQUFWLEVBQWlCQyxHQUFqQixDQUEzQixDQUFQO0FBSkksT0FBUDtBQU1OOztBQTNCVSxHQTdDTTs7QUE0RW5CLE9BQU07QUFDSixTQUFNSSxRQUFRQTtBQURWLEdBNUVhOztBQWdGbkIsT0FBTTtBQUNKLFNBQU1BLFFBQVFBO0FBRFYsR0FoRmE7O0FBb0ZuQixPQUFNO0FBQ0osU0FBTUEsUUFBUUE7QUFEVixHQXBGYTs7QUF3Rm5CLG9CQUFtQjs7QUFFakIsWUFBU0EsUUFBUUEsSUFGQTs7QUFJakIsYUFBUyxNQUFNZixLQUpFOztBQU1qQixhQUFTLENBQUVlLElBQUYsRUFBU0wsS0FBVCxFQUFpQkMsR0FBakIsS0FBMEI7O0FBRWpDLFlBQU0sQ0FBRTJCLEtBQUYsRUFBVUMsTUFBVixFQUFtQkMsS0FBbkIsSUFBNkJ6QixLQUFLTixRQUF4QztBQUNBLFlBQU1nQyxXQUFXSCxNQUFNZCxNQUFOLENBQWFrQixNQUFiLENBQW9CLENBQXBCLENBQWpCOztBQUVBLFVBQUkvQixJQUFJcUIsU0FBSixDQUFjQyxHQUFkLENBQWtCUSxRQUFsQixDQUFKLEVBQWlDO0FBQ3RDLGNBQU1FLE9BQU9oQyxJQUFJcUIsU0FBSixDQUFjSSxHQUFkLENBQWtCSyxRQUFsQixDQUFiO0FBQ0EsWUFBSUUsSUFBSixFQUFVLE9BQU90QyxFQUFHa0MsTUFBSCxFQUFZN0IsS0FBWixFQUFvQkMsR0FBcEIsQ0FBUCxDQUFWLEtBQ0ssSUFBSzZCLE1BQU1yQyxVQUFOLEtBQXFCLFFBQTFCLEVBQXFDO0FBQ3hDLGdCQUFNLENBQUV5QyxLQUFGLEVBQVVDLE1BQVYsRUFBbUJDLEdBQW5CLElBQTJCTixNQUFNL0IsUUFBdkM7QUFDQSxpQkFBT0osRUFBR3dDLE1BQUgsRUFBWW5DLEtBQVosRUFBb0JDLEdBQXBCLENBQVA7QUFDRCxTQUhJLE1BSUEsT0FBT1gsS0FBUDtBQUNDOztBQUVELGFBQU87QUFDWixnQkFBUyxNQURHO0FBRVosdUJBQWdCLGdCQUZKO0FBR1osc0JBQWUsT0FISDtBQUlaLG9CQUFhLHdCQUFPLENBQUUsQ0FBRXNDLEtBQUYsQ0FBRixFQUFjOUIsRUFBRyxDQUFDK0IsTUFBRCxFQUFTQyxLQUFULENBQUgsRUFBcUI5QixLQUFyQixFQUE2QkMsR0FBN0IsQ0FBZCxDQUFQO0FBSkQsT0FBUDtBQU9ELEtBNUJnQjs7QUE4QmpCLGdCQUFhLENBQUVJLElBQUYsRUFBU2dDLENBQVQsRUFBYXBDLEdBQWIsS0FBc0I7QUFDakMsWUFBTSxDQUFFcUMsUUFBRixJQUFlakMsS0FBS04sUUFBMUI7QUFDQSxZQUFNZSxTQUFTd0IsU0FBU3hCLE1BQXhCO0FBQ0EsWUFBTWlCLFdBQVdqQixPQUFPeUIsU0FBUCxDQUFpQixDQUFqQixFQUFvQnpCLE9BQU9hLE1BQVAsR0FBYyxDQUFsQyxDQUFqQjtBQUNBMUIsVUFBSXFCLFNBQUosQ0FBY2tCLEdBQWQsQ0FBa0JULFFBQWxCLEVBQTRCLEtBQTVCO0FBQ0EsYUFBT3pDLEtBQVA7QUFDRCxLQXBDZ0I7O0FBc0NqQixlQUFZLENBQUVlLElBQUYsRUFBU2dDLENBQVQsRUFBYXBDLEdBQWIsS0FBc0I7QUFDaEMsWUFBTSxDQUFFd0MsT0FBRixJQUFjcEMsS0FBS04sUUFBekI7QUFDQSxZQUFNZSxTQUFTMkIsUUFBUTNCLE1BQXZCO0FBQ0EsWUFBTWlCLFdBQVdqQixPQUFPeUIsU0FBUCxDQUFpQixDQUFqQixFQUFvQnpCLE9BQU9hLE1BQVAsR0FBYyxDQUFsQyxDQUFqQjtBQUNBMUIsVUFBSXFCLFNBQUosQ0FBY2tCLEdBQWQsQ0FBa0JULFFBQWxCLEVBQTRCLElBQTVCO0FBQ0EsYUFBT3pDLEtBQVA7QUFDRCxLQTVDZ0I7O0FBOENqQixlQUFXLE9BQVE7QUFDakIsY0FBUyxNQURRO0FBRWpCLGtCQUFhLFNBRkk7QUFHakIsZ0JBQVc7QUFITSxLQUFSLENBOUNNOztBQW9EakIsV0FBTyxDQUFFZSxJQUFGLEVBQVNMLEtBQVQsRUFBaUIsRUFBRXNCLFNBQUYsRUFBakIsS0FBb0M7QUFDekMsWUFBTSxDQUFFb0IsR0FBRixFQUFRaEMsUUFBUixFQUFtQmlDLEVBQW5CLEVBQXdCbkMsUUFBeEIsRUFBbUNvQyxFQUFuQyxJQUEwQ3ZDLEtBQUtOLFFBQXJEO0FBQ0EsWUFBTWMsTUFBTUgsU0FBU0ksTUFBckI7QUFDQVEsZ0JBQVVrQixHQUFWLENBQWMzQixHQUFkLEVBQW1CLENBQUMsQ0FBRCxFQUFJakIsZUFBSWlELFdBQUosQ0FBZ0JyQyxRQUFoQixDQUFKLENBQW5CO0FBQ0EsYUFBT2xCLEtBQVA7QUFDRCxLQXpEZ0I7O0FBMkRqQixrQkFBYyxDQUFFZSxJQUFGLEVBQVNMLEtBQVQsRUFBaUJDLEdBQWpCLEtBQTBCO0FBQ3RDLFlBQU0sQ0FBRTZDLFVBQUYsRUFBZUMsTUFBZixJQUEwQjFDLEtBQUtOLFFBQXJDO0FBQ0EsYUFBT0osRUFBR29ELE1BQUgsRUFBWS9DLEtBQVosRUFBb0JDLEdBQXBCLENBQVA7QUFDRCxLQTlEZ0I7O0FBZ0VqQixTQUFNSSxRQUFRQSxJQWhFRztBQWlFakIsVUFBT0EsUUFBUUEsSUFqRUU7QUFrRWpCLFVBQU9BLFFBQVFBLElBbEVFOztBQW9FakIsV0FBTyxDQUFFQSxJQUFGLEVBQVNMLEtBQVQsRUFBaUIsRUFBRVksSUFBRixFQUFTVSxTQUFULEVBQWpCLEtBQTJDO0FBQ2hELFlBQU0sQ0FBRUgsR0FBRixJQUFVZCxLQUFLTixRQUFyQjtBQUNBLFlBQU1pRCxJQUFJQyxTQUFTOUIsSUFBSUwsTUFBSixDQUFXa0IsTUFBWCxDQUFrQixDQUFsQixDQUFULEVBQStCLEVBQS9CLElBQXFDLENBQS9DLENBRmdELENBRUU7QUFDbEQsVUFBS2dCLEtBQUtwQyxLQUFLLENBQUwsRUFBUWUsTUFBbEIsRUFBMkIsTUFBTSxJQUFJakMsS0FBSixDQUFXLGNBQWF5QixHQUFJLGlCQUFnQlAsS0FBSyxDQUFMLEVBQVFlLE1BQU8sYUFBM0QsQ0FBTjtBQUMzQixZQUFNdUIsVUFBVXRDLEtBQUssQ0FBTCxFQUFRb0MsQ0FBUixDQUFoQixDQUpnRCxDQUluQjtBQUM3QixhQUFPckQsRUFBR3VELE9BQUgsRUFBYWxELEtBQWIsRUFBcUIsRUFBRVksTUFBTUEsS0FBSyxDQUFMLENBQVIsRUFBa0JVLFNBQWxCLEVBQXJCLENBQVA7QUFDRCxLQTFFZ0I7O0FBNEVqQixTQUFNakIsUUFBUUEsSUE1RUc7O0FBOEVqQixZQUFTLENBQUVBLElBQUYsRUFBU0wsS0FBVCxFQUFpQkMsR0FBakIsS0FBMEI7QUFDakMsWUFBTSxDQUFFTSxLQUFGLEVBQVVDLFFBQVYsRUFBcUJDLE1BQXJCLElBQWdDSixLQUFLTixRQUEzQztBQUNBLGFBQU87QUFDWixnQkFBUyxNQURHO0FBRVosdUJBQWdCLGdCQUZKO0FBR1osc0JBQWUsTUFISDtBQUlaLG9CQUFhLHdCQUFPLENBQUUsQ0FBRVEsS0FBRixDQUFGLEVBQWNULEVBQUcsQ0FBRVUsUUFBRixDQUFILEVBQWtCUixLQUFsQixFQUEwQkMsR0FBMUIsQ0FBZCxFQUFnRCxDQUFFUSxNQUFGLENBQWhELENBQVA7QUFKRCxPQUFQO0FBTUQsS0F0RmdCOztBQXdGakIsZUFBWSxDQUFFSixJQUFGLEVBQVNMLEtBQVQsRUFBaUJDLEdBQWpCLEtBQTBCO0FBQ3BDLFlBQU0sQ0FBRU0sS0FBRixFQUFVQyxRQUFWLEVBQXFCQyxNQUFyQixJQUFnQ0osS0FBS04sUUFBM0M7QUFDQSxhQUFPO0FBQ1osZ0JBQVMsTUFERztBQUVaLHVCQUFnQixnQkFGSjtBQUdaLHNCQUFlLFNBSEg7QUFJWixvQkFBYSx3QkFBTyxDQUFFLENBQUVRLEtBQUYsQ0FBRixFQUFjVCxFQUFHLENBQUVVLFFBQUYsQ0FBSCxFQUFrQlIsS0FBbEIsRUFBMEJDLEdBQTFCLENBQWQsRUFBZ0QsQ0FBRVEsTUFBRixDQUFoRCxDQUFQO0FBSkQsT0FBUDtBQU1EOztBQWhHZ0IsR0F4RkE7O0FBNExuQixXQUFTOztBQUVQLGNBQVcsQ0FBRUosSUFBRixFQUFTTCxLQUFULEVBQWlCQyxHQUFqQixLQUEwQjtBQUNuQyxZQUFNLENBQUVpQyxLQUFGLEVBQVUxQixRQUFWLEVBQXFCNEIsR0FBckIsSUFBNkIvQixLQUFLTixRQUF4QztBQUNBLGFBQU87QUFDWixnQkFBUyxNQURHO0FBRVosdUJBQWdCLE9BRko7QUFHWixzQkFBZSxRQUhIO0FBSVosb0JBQWEsd0JBQU0sQ0FBRSxDQUFFbUMsS0FBRixDQUFGLEVBQWNwQyxFQUFHLENBQUVVLFFBQUYsQ0FBSCxFQUFrQlIsS0FBbEIsRUFBMEJDLEdBQTFCLENBQWQsRUFBZ0QsQ0FBRW1DLEdBQUYsQ0FBaEQsQ0FBTjtBQUpELE9BQVA7QUFNRCxLQVZNOztBQVlQLFVBQU8sT0FBUSxFQUFFO0FBQ2YsY0FBUyxNQURJO0FBRWIsa0JBQWEsTUFGQTtBQUdiLGdCQUFXO0FBSEUsS0FBUjs7QUFaQSxHQTVMVTs7QUFnTm5CLFlBQVc7O0FBRVQsMEJBQXNCLENBQUUvQixJQUFGLEVBQVNnQyxDQUFULEVBQWEsRUFBRWYsU0FBRixFQUFiLEtBQWdDO0FBQ3BELFlBQU0sQ0FBRTZCLEVBQUYsRUFBT3pDLFFBQVAsRUFBa0IwQyxFQUFsQixFQUF1QkMsVUFBdkIsRUFBb0NWLEVBQXBDLEVBQXlDbkMsUUFBekMsRUFBb0RvQyxFQUFwRCxJQUEyRHZDLEtBQUtOLFFBQXRFO0FBQ0EsWUFBTWMsTUFBTUgsU0FBU0ksTUFBckI7QUFDQSxVQUFJVSxRQUFRLENBQVo7QUFDQSxVQUFJNkIsV0FBVzVELFVBQVgsS0FBMEIsS0FBOUIsRUFBcUM7QUFDMUMsY0FBTSxDQUFFNkQsRUFBRixFQUFPQyxJQUFQLEVBQWNDLEVBQWQsSUFBcUJILFdBQVd0RCxRQUF0QztBQUNBeUIsZ0JBQVF5QixTQUFTTSxLQUFLekMsTUFBZCxFQUFzQixFQUF0QixDQUFSO0FBQ007QUFDRFEsZ0JBQVVrQixHQUFWLENBQWMzQixHQUFkLEVBQW1CLENBQUVXLEtBQUYsRUFBVWhCLFFBQVYsQ0FBbkI7QUFDQSxhQUFPbEIsS0FBUDtBQUNELEtBWlE7O0FBY1Qsd0JBQW9CLENBQUVlLElBQUYsRUFBU2dDLENBQVQsRUFBYSxFQUFFZixTQUFGLEVBQWIsS0FBZ0M7QUFDbEQsWUFBTSxDQUFFWixRQUFGLEVBQWEyQyxVQUFiLEVBQTBCVixFQUExQixFQUErQm5DLFFBQS9CLEVBQTBDb0MsRUFBMUMsSUFBaUR2QyxLQUFLTixRQUE1RDtBQUNBLFlBQU1jLE1BQU1ILFNBQVNJLE1BQXJCO0FBQ0EsVUFBSVUsUUFBUSxDQUFaO0FBQ0EsVUFBSTZCLFdBQVc1RCxVQUFYLEtBQTBCLEtBQTlCLEVBQXFDO0FBQzFDLGNBQU0sQ0FBRTZELEVBQUYsRUFBT0MsSUFBUCxFQUFjQyxFQUFkLElBQXFCSCxXQUFXdEQsUUFBdEM7QUFDQXlCLGdCQUFReUIsU0FBU00sS0FBS3pDLE1BQWQsRUFBc0IsRUFBdEIsQ0FBUjtBQUNNO0FBQ0RRLGdCQUFVa0IsR0FBVixDQUFjM0IsR0FBZCxFQUFtQixDQUFFVyxLQUFGLEVBQVVoQixRQUFWLENBQW5CO0FBQ0EsYUFBT2xCLEtBQVA7QUFDRCxLQXhCUTs7QUEwQlQseUJBQXFCLENBQUVlLElBQUYsRUFBU2dDLENBQVQsRUFBYSxFQUFFZixTQUFGLEVBQWIsS0FBZ0M7QUFDbkQ7QUFDQSxZQUFNLENBQUU4QixFQUFGLEVBQU8xQyxRQUFQLEVBQWtCMkMsVUFBbEIsRUFBK0JWLEVBQS9CLEVBQW9DbkMsUUFBcEMsRUFBK0NvQyxFQUEvQyxJQUFzRHZDLEtBQUtOLFFBQWpFO0FBQ0EsWUFBTWMsTUFBTUgsU0FBU0ksTUFBckI7QUFDQSxVQUFJVSxRQUFRLENBQVo7QUFDQSxVQUFJNkIsV0FBVzVELFVBQVgsS0FBMEIsS0FBOUIsRUFBcUM7QUFDMUMsY0FBTSxDQUFFNkQsRUFBRixFQUFPQyxJQUFQLEVBQWNDLEVBQWQsSUFBcUJILFdBQVd0RCxRQUF0QztBQUNBeUIsZ0JBQVF5QixTQUFTTSxLQUFLekMsTUFBZCxFQUFzQixFQUF0QixDQUFSO0FBQ007QUFDRFEsZ0JBQVVrQixHQUFWLENBQWMzQixHQUFkLEVBQW1CLENBQUVXLEtBQUYsRUFBVWhCLFFBQVYsQ0FBbkI7QUFDQSxhQUFPbEIsS0FBUDtBQUNEOztBQXJDUSxHQWhOUTs7QUF5UG5CLGdCQUFjO0FBQ1osV0FBUUMsSUFBSyxZQUFMLEVBQW9CLEtBQXBCLENBREk7QUFFWixVQUFPQSxJQUFLLFlBQUwsRUFBb0IsSUFBcEI7QUFGSyxHQXpQSzs7QUE4UG5CLFVBQVE7QUFDTixXQUFRQSxJQUFLLE1BQUwsRUFBYyxLQUFkLENBREY7QUFFTixVQUFPQSxJQUFLLE1BQUwsRUFBYyxJQUFkO0FBRkQsR0E5UFc7O0FBbVFuQixhQUFXO0FBQ1QsY0FBV2EsUUFBUSxTQUFSLEVBQW1CLFFBQW5CLENBREY7QUFFVCxnQkFBYUEsUUFBUSxTQUFSLEVBQW1CLFVBQW5CLENBRko7QUFHVCxXQUFRLE1BQU1kO0FBSEwsR0FuUVE7O0FBeVFuQixjQUFZO0FBQ1YsZ0JBQWFjLFFBQVEsVUFBUixFQUFvQixVQUFwQixDQURIO0FBRVYsb0NBQWlDQSxRQUFRLFVBQVIsRUFBb0IsOEJBQXBCLENBRnZCO0FBR1YsdUJBQW9CQSxRQUFRLFVBQVIsRUFBb0IsaUJBQXBCLENBSFY7QUFJVixlQUFZLE1BQU1kO0FBSlIsR0F6UU87O0FBZ1JuQix3QkFBc0I7QUFDcEIsZ0JBQWFjLFFBQVEsb0JBQVIsRUFBOEIsVUFBOUIsQ0FETztBQUVwQixvQ0FBaUNBLFFBQVEsb0JBQVIsRUFBOEIsOEJBQTlCLENBRmI7QUFHcEIsZUFBWSxNQUFNZDtBQUhFOztBQWhSSCxDQUFkIiwiZmlsZSI6InNoYWtlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY2hhaW4gfSBmcm9tICdAYXVyZW9vbXMvanMtaXRlcnRvb2xzJyA7XG5pbXBvcnQgeyBhc3QgfSBmcm9tICdAYXVyZW9vbXMvanMtZ3JhbW1hcicgO1xuXG5jb25zdCBlbXB0eSA9IHtcbiAgJ3R5cGUnIDogJ25vZGUnICxcbiAgJ25vbnRlcm1pbmFsJyA6ICdlbXB0eScgLFxuICAncHJvZHVjdGlvbicgOiAnbWFpbicgLFxuICAnY2hpbGRyZW4nIDogW10gLFxufSA7XG5cbmNvbnN0IGVyciA9ICggbm9udGVybWluYWwgLCBwcm9kdWN0aW9uICkgPT4gKCkgPT4ge1xuICB0aHJvdyBuZXcgRXJyb3IoYCR7bm9udGVybWluYWx9LiR7cHJvZHVjdGlvbn0gc2hvdWxkIGhhdmUgYmVlbiBoYW5kbGVkIGJlZm9yZWApO1xufSA7XG5cbmNvbnN0IHQgPSBhc3QudHJhbnNmb3JtIDtcbmNvbnN0IG0gPSAoIGNoaWxkcmVuICwgbWF0Y2ggLCBjdHggKSA9PiBhc3QuY21hcCggY2hpbGQgPT4gdCggY2hpbGQgLCBtYXRjaCAsIGN0eCApICwgY2hpbGRyZW4gKSA7XG5cbmNvbnN0IHJlY3Vyc2UgPSAoIG5vbnRlcm1pbmFsICwgcHJvZHVjdGlvbiApID0+ICggdHJlZSAsIG1hdGNoICwgY3R4ICkgPT4gKHtcbiAgXCJ0eXBlXCIgOiBcIm5vZGVcIiAsXG4gIG5vbnRlcm1pbmFsICxcbiAgcHJvZHVjdGlvbiAsXG4gIFwiY2hpbGRyZW5cIiA6IG0oIHRyZWUuY2hpbGRyZW4gLCBtYXRjaCAsIGN0eCApICxcbn0pIDtcblxuXG5leHBvcnQgY29uc3Qgc2hha2UgPSB7XG5cbiAgXCJhbnl0aGluZ1wiIDoge1xuICAgIFwic3RhcnRzLXdpdGgtb3RoZXJjbWRcIiA6IHJlY3Vyc2UoICdhbnl0aGluZycgLCAnc3RhcnRzLXdpdGgtb3RoZXJjbWQnICkgLFxuICAgIFwic3RhcnRzLXdpdGgtKlwiIDogcmVjdXJzZSggJ2FueXRoaW5nJyAsICdzdGFydHMtd2l0aC0qJyApICxcbiAgICBcInN0YXJ0cy13aXRoLVtcIiA6IHJlY3Vyc2UoICdhbnl0aGluZycgLCAnc3RhcnRzLXdpdGgtWycgKSAsXG4gICAgXCJzdGFydHMtd2l0aC1dXCIgOiByZWN1cnNlKCAnYW55dGhpbmcnICwgJ3N0YXJ0cy13aXRoLV0nICkgLFxuICAgIFwic3RhcnRzLXdpdGgtYS1ncm91cFwiIDogcmVjdXJzZSggJ2FueXRoaW5nJyAsICdzdGFydHMtd2l0aC1hLWdyb3VwJyApICxcbiAgICBcInN0YXJ0cy13aXRoLXNvbWV0aGluZy1lbHNlXCIgOiByZWN1cnNlKCAnYW55dGhpbmcnICwgJ3N0YXJ0cy13aXRoLXNvbWV0aGluZy1lbHNlJyApICxcbiAgICBcImVuZFwiIDogKCkgPT4gZW1wdHkgLFxuICB9ICxcblxuICBcImFueXRoaW5nLWJ1dC1dXCIgOiB7XG4gICAgXCJzdGFydHMtd2l0aC1vdGhlcmNtZFwiIDogcmVjdXJzZSggJ2FueXRoaW5nLWJ1dC1dJyAsICdzdGFydHMtd2l0aC1vdGhlcmNtZCcgKSAsXG4gICAgXCJzdGFydHMtd2l0aC0qXCIgOiByZWN1cnNlKCAnYW55dGhpbmcnICwgJ3N0YXJ0cy13aXRoLSonICkgLFxuICAgIFwic3RhcnRzLXdpdGgtW1wiIDogcmVjdXJzZSggJ2FueXRoaW5nJyAsICdzdGFydHMtd2l0aC1bJyApICxcbiAgICBcInN0YXJ0cy13aXRoLWEtZ3JvdXBcIiA6IHJlY3Vyc2UoICdhbnl0aGluZy1idXQtXScgLCAnc3RhcnRzLXdpdGgtYS1ncm91cCcgKSAsXG4gICAgXCJzdGFydHMtd2l0aC1zb21ldGhpbmctZWxzZVwiIDogcmVjdXJzZSggJ2FueXRoaW5nLWJ1dC1dJyAsICdzdGFydHMtd2l0aC1zb21ldGhpbmctZWxzZScgKSAsXG4gICAgXCJlbmRcIiA6ICgpID0+IGVtcHR5ICxcbiAgfSAsXG5cbiAgXCJncm91cFwiIDoge1xuICAgIFwiZ3JvdXBcIiA6ICggdHJlZSAsIG1hdGNoICwgY3R4ICkgPT4ge1xuICAgICAgY29uc3QgWyBfb3BlbiAsIGFueXRoaW5nICwgX2Nsb3NlIF0gPSB0cmVlLmNoaWxkcmVuIDtcbiAgICAgIHJldHVybiB7XG5cdFwidHlwZVwiIDogXCJub2RlXCIgLFxuXHRcIm5vbnRlcm1pbmFsXCIgOiBcImdyb3VwXCIgLFxuXHRcInByb2R1Y3Rpb25cIiA6IFwiZ3JvdXBcIiAsXG5cdFwiY2hpbGRyZW5cIiA6IGNoYWluKCBbIFsgX29wZW4gXSAsIG0oIFsgYW55dGhpbmcgXSAsIG1hdGNoICwgY3R4ICkgLCBbIF9jbG9zZSBdIF0gKSAsXG4gICAgICB9IDtcbiAgICB9ICxcbiAgfSAsXG5cbiAgXCJvcHRncm91cFwiIDoge1xuICAgIFwiZ3JvdXBcIiA6ICggdHJlZSAsIG1hdGNoICwgY3R4ICkgPT4ge1xuICAgICAgY29uc3QgWyBfb3BlbiAsIGFueXRoaW5nICwgX2Nsb3NlIF0gPSB0cmVlLmNoaWxkcmVuIDtcbiAgICAgIHJldHVybiB7XG5cdFwidHlwZVwiIDogXCJub2RlXCIgLFxuXHRcIm5vbnRlcm1pbmFsXCIgOiBcIm9wdGdyb3VwXCIgLFxuXHRcInByb2R1Y3Rpb25cIiA6IFwiZ3JvdXBcIiAsXG5cdFwiY2hpbGRyZW5cIiA6IGNoYWluKCBbIFsgX29wZW4gXSAsIG0oIFsgYW55dGhpbmcgXSAsIG1hdGNoICwgY3R4ICkgLCBbIF9jbG9zZSBdIF0gKSAsXG4gICAgICB9IDtcbiAgICB9ICxcbiAgfSAsXG5cbiAgXCJvdGhlcmNtZFwiIDoge1xuXG4gICAgXCJvdGhlcmNtZFwiOiAoIHRyZWUgLCBtYXRjaCAsIGN0eCApID0+IHtcbiAgICAgIGNvbnN0IFsgb3RoZXJjbWQgLCBvcHRzdGFyICwgYXJncyBdID0gdHJlZS5jaGlsZHJlbiA7XG4gICAgICBsZXQgY21kID0gb3RoZXJjbWQuYnVmZmVyO1xuICAgICAgaWYgKCBvcHRzdGFyLnByb2R1Y3Rpb24gPT09ICd5ZXMnICkgY21kICs9ICcqJztcbiAgICAgIGNvbnN0IGNtZGFyZ3MgPSBbXTtcbiAgICAgIGxldCBhcmdfaSA9IGFyZ3NcbiAgICAgIHdoaWxlICggYXJnX2kucHJvZHVjdGlvbiA9PT0gJ25vcm1hbCcgKSB7XG5cdGNvbnN0IFsgZ3JvdXAgLCBhcmdzdGFpbCBdID0gYXJnX2kuY2hpbGRyZW4gO1xuXHRjb25zdCBbIF9vcGVuICwgYXJnICwgX2Nsb3NlIF0gPSBncm91cC5jaGlsZHJlbiA7XG5cdGNtZGFyZ3MucHVzaChhcmcpIDtcblx0YXJnX2kgPSBhcmdzdGFpbCA7XG4gICAgICB9XG4gICAgICBjb25zdCBoYXNvcHRhcmdzID0gYXJnX2kucHJvZHVjdGlvbiA9PT0gJ29wdGlvbmFsJyA7XG4gICAgICBpZiAoIWhhc29wdGFyZ3MgJiYgY3R4LnZhcmlhYmxlcy5oYXMoY21kKSkge1xuXHQvLyB0b28gaGFyZCB0byBwYXJzZSBvcHQgYXJncyBjdXJyZW50bHlcblx0Y29uc3QgWyBuYXJncyAsIGV4cGFuZHN0byBdID0gY3R4LnZhcmlhYmxlcy5nZXQoY21kKSA7XG5cdGlmIChjbWRhcmdzLmxlbmd0aCAhPT0gbmFyZ3MpIHRocm93IG5ldyBFcnJvcihgQ29tbWFuZCAke2NtZH0gaXMgZGVmaW5lZCB3aXRoICR7bmFyZ3N9IGFyZ3VtZW50cyBidXQgJHtjbWRhcmdzLmxlbmd0aH0gd2VyZSBnaXZlbi5gKSA7XG5cdHJldHVybiB0KCBleHBhbmRzdG8gLCBtYXRjaCAsIHsgdmFyaWFibGVzOiBjdHgudmFyaWFibGVzICwgYXJnczogWyBjdHguYXJncyAsIGNtZGFyZ3MgXSB9ICkgO1xuICAgICAgfVxuICAgICAgZWxzZSByZXR1cm4ge1xuXHQndHlwZScgOiAnbm9kZScgLFxuXHQnbm9udGVybWluYWwnIDogJ290aGVyY21kJyAsXG5cdCdwcm9kdWN0aW9uJyA6ICdvdGhlcmNtZCcgLFxuXHQnY2hpbGRyZW4nIDogY2hhaW4oIFsgWyBvdGhlcmNtZCAsIG9wdHN0YXIgXSAsIG0oW2FyZ3NdLCBtYXRjaCwgY3R4KSBdICkgLFxuICAgICAgfSA7XG4gICAgfSAsXG5cbiAgfSAsXG5cbiAgXCIqXCIgOiB7XG4gICAgXCIqXCIgOiB0cmVlID0+IHRyZWUgLFxuICB9ICxcblxuICBcIltcIiA6IHtcbiAgICBcIltcIiA6IHRyZWUgPT4gdHJlZSAsXG4gIH0gLFxuXG4gIFwiXVwiIDoge1xuICAgIFwiXVwiIDogdHJlZSA9PiB0cmVlICxcbiAgfSAsXG5cbiAgXCJzb21ldGhpbmctZWxzZVwiIDoge1xuXG4gICAgXCJ0ZXh0XCIgOiB0cmVlID0+IHRyZWUgLFxuXG4gICAgXCJuZXdpZlwiOiAoKSA9PiBlbXB0eSAsXG5cbiAgICBcImlmY21kXCI6ICggdHJlZSAsIG1hdGNoICwgY3R4ICkgPT4ge1xuXG4gICAgICBjb25zdCBbIGlmY21kICwgYmxvY2sxICwgZW5kaWYgXSA9IHRyZWUuY2hpbGRyZW4gO1xuICAgICAgY29uc3QgdmFyaWFibGUgPSBpZmNtZC5idWZmZXIuc3Vic3RyKDMpO1xuXG4gICAgICBpZiAoY3R4LnZhcmlhYmxlcy5oYXModmFyaWFibGUpKSB7XG5cdGNvbnN0IGZsYWcgPSBjdHgudmFyaWFibGVzLmdldCh2YXJpYWJsZSk7XG5cdGlmIChmbGFnKSByZXR1cm4gdCggYmxvY2sxICwgbWF0Y2ggLCBjdHggKSA7XG5cdGVsc2UgaWYgKCBlbmRpZi5wcm9kdWN0aW9uID09PSBcImVsc2VmaVwiICkge1xuXHQgIGNvbnN0IFsgX2Vsc2UgLCBibG9jazIgLCBfZmkgXSA9IGVuZGlmLmNoaWxkcmVuIDtcblx0ICByZXR1cm4gdCggYmxvY2syICwgbWF0Y2ggLCBjdHggKSA7XG5cdH1cblx0ZWxzZSByZXR1cm4gZW1wdHkgO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuXHQndHlwZScgOiAnbm9kZScgLFxuXHQnbm9udGVybWluYWwnIDogJ3NvbWV0aGluZy1lbHNlJyAsXG5cdCdwcm9kdWN0aW9uJyA6ICdpZmNtZCcgLFxuXHQnY2hpbGRyZW4nIDogY2hhaW4oIFsgWyBpZmNtZCBdICwgbSggW2Jsb2NrMSwgZW5kaWZdICwgbWF0Y2ggLCBjdHggKSBdICkgLFxuICAgICAgfSA7XG5cbiAgICB9ICxcblxuICAgIFwiZmFsc2VjbWRcIiA6ICggdHJlZSAsIF8gLCBjdHggKSA9PiB7XG4gICAgICBjb25zdCBbIGZhbHNlY21kIF0gPSB0cmVlLmNoaWxkcmVuIDtcbiAgICAgIGNvbnN0IGJ1ZmZlciA9IGZhbHNlY21kLmJ1ZmZlcjtcbiAgICAgIGNvbnN0IHZhcmlhYmxlID0gYnVmZmVyLnN1YnN0cmluZygxLCBidWZmZXIubGVuZ3RoLTUpO1xuICAgICAgY3R4LnZhcmlhYmxlcy5zZXQodmFyaWFibGUsIGZhbHNlKTtcbiAgICAgIHJldHVybiBlbXB0eTtcbiAgICB9ICxcblxuICAgIFwidHJ1ZWNtZFwiIDogKCB0cmVlICwgXyAsIGN0eCApID0+IHtcbiAgICAgIGNvbnN0IFsgdHJ1ZWNtZCBdID0gdHJlZS5jaGlsZHJlbiA7XG4gICAgICBjb25zdCBidWZmZXIgPSB0cnVlY21kLmJ1ZmZlcjtcbiAgICAgIGNvbnN0IHZhcmlhYmxlID0gYnVmZmVyLnN1YnN0cmluZygxLCBidWZmZXIubGVuZ3RoLTQpO1xuICAgICAgY3R4LnZhcmlhYmxlcy5zZXQodmFyaWFibGUsIHRydWUpO1xuICAgICAgcmV0dXJuIGVtcHR5O1xuICAgIH0gLFxuXG4gICAgXCJjb21tZW50XCI6ICggKSA9PiAoe1xuICAgICAgJ3R5cGUnIDogJ2xlYWYnICxcbiAgICAgICd0ZXJtaW5hbCcgOiAnY29tbWVudCcgLFxuICAgICAgJ2J1ZmZlcicgOiAnJScgLFxuICAgIH0pICxcblxuICAgIFwiZGVmXCI6ICggdHJlZSAsIG1hdGNoICwgeyB2YXJpYWJsZXMgfSApID0+IHtcbiAgICAgIGNvbnN0IFsgZGVmICwgb3RoZXJjbWQgLCBfMiAsIGFueXRoaW5nICwgXzMgXSA9IHRyZWUuY2hpbGRyZW4gO1xuICAgICAgY29uc3QgY21kID0gb3RoZXJjbWQuYnVmZmVyO1xuICAgICAgdmFyaWFibGVzLnNldChjbWQsIFswLCBhc3QubWF0ZXJpYWxpemUoYW55dGhpbmcpXSk7XG4gICAgICByZXR1cm4gZW1wdHkgO1xuICAgIH0gLFxuXG4gICAgXCJuZXdjb21tYW5kXCI6ICggdHJlZSAsIG1hdGNoICwgY3R4ICkgPT4ge1xuICAgICAgY29uc3QgWyBuZXdjb21tYW5kICwgY21kZGVmIF0gPSB0cmVlLmNoaWxkcmVuIDtcbiAgICAgIHJldHVybiB0KCBjbWRkZWYgLCBtYXRjaCAsIGN0eCApIDtcbiAgICB9ICxcblxuICAgIFwiIFwiIDogdHJlZSA9PiB0cmVlICxcbiAgICBcIlxcdFwiIDogdHJlZSA9PiB0cmVlICxcbiAgICBcIlxcblwiIDogdHJlZSA9PiB0cmVlICxcblxuICAgIFwiYXJnXCI6ICggdHJlZSAsIG1hdGNoICwgeyBhcmdzICwgdmFyaWFibGVzIH0gKSA9PiB7XG4gICAgICBjb25zdCBbIGFyZyBdID0gdHJlZS5jaGlsZHJlbiA7XG4gICAgICBjb25zdCBpID0gcGFyc2VJbnQoYXJnLmJ1ZmZlci5zdWJzdHIoMSksIDEwKSAtIDE7IC8vICNhcmdcbiAgICAgIGlmICggaSA+PSBhcmdzWzFdLmxlbmd0aCApIHRocm93IG5ldyBFcnJvcihgUmVxdWVzdGluZyAke2FyZ30gYnV0IG9ubHkgZ290ICR7YXJnc1sxXS5sZW5ndGh9IGFyZ3VtZW50cy5gKSA7XG4gICAgICBjb25zdCBzdWJ0cmVlID0gYXJnc1sxXVtpXSA7IC8vIGFyZ1xuICAgICAgcmV0dXJuIHQoIHN1YnRyZWUgLCBtYXRjaCAsIHsgYXJnczogYXJnc1swXSAsIHZhcmlhYmxlcyB9ICkgO1xuICAgIH0gLFxuXG4gICAgXCIkXCIgOiB0cmVlID0+IHRyZWUgLFxuXG4gICAgXCJtYXRoXCIgOiAoIHRyZWUgLCBtYXRjaCAsIGN0eCApID0+IHtcbiAgICAgIGNvbnN0IFsgX29wZW4gLCBhbnl0aGluZyAsIF9jbG9zZSBdID0gdHJlZS5jaGlsZHJlbiA7XG4gICAgICByZXR1cm4ge1xuXHRcInR5cGVcIiA6IFwibm9kZVwiICxcblx0XCJub250ZXJtaW5hbFwiIDogJ3NvbWV0aGluZy1lbHNlJyAsXG5cdFwicHJvZHVjdGlvblwiIDogXCJtYXRoXCIgLFxuXHRcImNoaWxkcmVuXCIgOiBjaGFpbiggWyBbIF9vcGVuIF0gLCBtKCBbIGFueXRoaW5nIF0gLCBtYXRjaCAsIGN0eCApICwgWyBfY2xvc2UgXSBdICkgLFxuICAgICAgfSA7XG4gICAgfSAsXG5cbiAgICBcIm1hdGhlbnZcIiA6ICggdHJlZSAsIG1hdGNoICwgY3R4ICkgPT4ge1xuICAgICAgY29uc3QgWyBfb3BlbiAsIGFueXRoaW5nICwgX2Nsb3NlIF0gPSB0cmVlLmNoaWxkcmVuIDtcbiAgICAgIHJldHVybiB7XG5cdFwidHlwZVwiIDogXCJub2RlXCIgLFxuXHRcIm5vbnRlcm1pbmFsXCIgOiAnc29tZXRoaW5nLWVsc2UnICxcblx0XCJwcm9kdWN0aW9uXCIgOiBcIm1hdGhlbnZcIiAsXG5cdFwiY2hpbGRyZW5cIiA6IGNoYWluKCBbIFsgX29wZW4gXSAsIG0oIFsgYW55dGhpbmcgXSAsIG1hdGNoICwgY3R4ICkgLCBbIF9jbG9zZSBdIF0gKSAsXG4gICAgICB9IDtcbiAgICB9ICxcblxuICB9ICxcblxuICBcImVuZGlmXCI6IHtcblxuICAgIFwiZWxzZWZpXCIgOiAoIHRyZWUgLCBtYXRjaCAsIGN0eCApID0+IHtcbiAgICAgIGNvbnN0IFsgX2Vsc2UgLCBhbnl0aGluZyAsIF9maSBdID0gdHJlZS5jaGlsZHJlbiA7XG4gICAgICByZXR1cm4ge1xuXHRcInR5cGVcIiA6IFwibm9kZVwiICxcblx0XCJub250ZXJtaW5hbFwiIDogXCJlbmRpZlwiICxcblx0XCJwcm9kdWN0aW9uXCIgOiBcImVsc2VmaVwiICxcblx0XCJjaGlsZHJlblwiIDogY2hhaW4oWyBbIF9lbHNlIF0gLCBtKCBbIGFueXRoaW5nIF0gLCBtYXRjaCAsIGN0eCApICwgWyBfZmkgXSBdICkgLFxuICAgICAgfSA7XG4gICAgfSAsXG5cbiAgICBcImZpXCIgOiAoICkgPT4gKHsgLy8gdHJlZSA9PiB0cmVlID9cbiAgICAgIFwidHlwZVwiIDogXCJsZWFmXCIgLFxuICAgICAgXCJ0ZXJtaW5hbFwiIDogXCJ0ZXh0XCIgLFxuICAgICAgXCJidWZmZXJcIiA6ICdcXFxcZmknICxcbiAgICB9KSAsXG5cbiAgfSAsXG5cbiAgXCJjbWRkZWZcIiA6IHtcblxuICAgIFwie2NtZH1beF17YW55dGhpbmd9XCI6ICggdHJlZSAsIF8gLCB7IHZhcmlhYmxlcyB9ICkgPT4ge1xuICAgICAgY29uc3QgWyBfMCAsIG90aGVyY21kICwgXzEgLCBjbWRkZWZhcmdzICwgXzIgLCBhbnl0aGluZyAsIF8zIF0gPSB0cmVlLmNoaWxkcmVuIDtcbiAgICAgIGNvbnN0IGNtZCA9IG90aGVyY21kLmJ1ZmZlcjtcbiAgICAgIGxldCBuYXJncyA9IDA7XG4gICAgICBpZiAoY21kZGVmYXJncy5wcm9kdWN0aW9uID09PSAneWVzJykge1xuXHRjb25zdCBbIF80ICwgdGV4dCAsIF81IF0gPSBjbWRkZWZhcmdzLmNoaWxkcmVuIDtcblx0bmFyZ3MgPSBwYXJzZUludCh0ZXh0LmJ1ZmZlciwgMTApO1xuICAgICAgfVxuICAgICAgdmFyaWFibGVzLnNldChjbWQsIFsgbmFyZ3MgLCBhbnl0aGluZyBdKTtcbiAgICAgIHJldHVybiBlbXB0eTtcbiAgICB9ICxcblxuICAgIFwiY21kW3hde2FueXRoaW5nfVwiOiAoIHRyZWUgLCBfICwgeyB2YXJpYWJsZXMgfSApID0+IHtcbiAgICAgIGNvbnN0IFsgb3RoZXJjbWQgLCBjbWRkZWZhcmdzICwgXzIgLCBhbnl0aGluZyAsIF8zIF0gPSB0cmVlLmNoaWxkcmVuIDtcbiAgICAgIGNvbnN0IGNtZCA9IG90aGVyY21kLmJ1ZmZlcjtcbiAgICAgIGxldCBuYXJncyA9IDA7XG4gICAgICBpZiAoY21kZGVmYXJncy5wcm9kdWN0aW9uID09PSAneWVzJykge1xuXHRjb25zdCBbIF80ICwgdGV4dCAsIF81IF0gPSBjbWRkZWZhcmdzLmNoaWxkcmVuIDtcblx0bmFyZ3MgPSBwYXJzZUludCh0ZXh0LmJ1ZmZlciwgMTApO1xuICAgICAgfVxuICAgICAgdmFyaWFibGVzLnNldChjbWQsIFsgbmFyZ3MgLCBhbnl0aGluZyBdKTtcbiAgICAgIHJldHVybiBlbXB0eTtcbiAgICB9ICxcblxuICAgIFwiKmNtZFt4XXthbnl0aGluZ31cIjogKCB0cmVlICwgXyAsIHsgdmFyaWFibGVzIH0gKSA9PiB7XG4gICAgICAvLyBkbyBub3Qga25vdyB3aGF0IHRvIGRvIHdpdGggJyonIGF0IHRoZSBtb21lbnRcbiAgICAgIGNvbnN0IFsgXzEgLCBvdGhlcmNtZCAsIGNtZGRlZmFyZ3MgLCBfMiAsIGFueXRoaW5nICwgXzMgXSA9IHRyZWUuY2hpbGRyZW4gO1xuICAgICAgY29uc3QgY21kID0gb3RoZXJjbWQuYnVmZmVyO1xuICAgICAgbGV0IG5hcmdzID0gMDtcbiAgICAgIGlmIChjbWRkZWZhcmdzLnByb2R1Y3Rpb24gPT09ICd5ZXMnKSB7XG5cdGNvbnN0IFsgXzQgLCB0ZXh0ICwgXzUgXSA9IGNtZGRlZmFyZ3MuY2hpbGRyZW4gO1xuXHRuYXJncyA9IHBhcnNlSW50KHRleHQuYnVmZmVyLCAxMCk7XG4gICAgICB9XG4gICAgICB2YXJpYWJsZXMuc2V0KGNtZCwgWyBuYXJncyAsIGFueXRoaW5nIF0pO1xuICAgICAgcmV0dXJuIGVtcHR5O1xuICAgIH0gLFxuXG4gIH0gLFxuXG4gIFwiY21kZGVmYXJnc1wiOiB7XG4gICAgXCJ5ZXNcIiA6IGVyciggXCJjbWRkZWZhcmdzXCIgLCBcInllc1wiICkgLFxuICAgIFwibm9cIiA6IGVyciggXCJjbWRkZWZhcmdzXCIgLCBcIm5vXCIgKSAsXG4gIH0gLFxuXG4gIFwiY21kKlwiOiB7XG4gICAgXCJ5ZXNcIiA6IGVyciggXCJjbWQqXCIgLCBcInllc1wiICkgLFxuICAgIFwibm9cIiA6IGVyciggXCJjbWQqXCIgLCBcIm5vXCIgKSAsXG4gIH0gLFxuXG4gIFwiY21kYXJnc1wiOiB7XG4gICAgXCJub3JtYWxcIiA6IHJlY3Vyc2UoJ2NtZGFyZ3MnLCAnbm9ybWFsJykgLFxuICAgIFwib3B0aW9uYWxcIiA6IHJlY3Vyc2UoJ2NtZGFyZ3MnLCAnb3B0aW9uYWwnKSAsXG4gICAgXCJlbmRcIiA6ICgpID0+IGVtcHR5ICxcbiAgfSAsXG5cbiAgXCJjbWRhZnRlclwiOiB7XG4gICAgXCJvdGhlcmNtZFwiIDogcmVjdXJzZSgnY21kYWZ0ZXInLCAnb3RoZXJjbWQnICkgLFxuICAgIFwic29tZXRoaW5nLWVsc2UtdGhlbi1hbnl0aGluZ1wiIDogcmVjdXJzZSgnY21kYWZ0ZXInLCAnc29tZXRoaW5nLWVsc2UtdGhlbi1hbnl0aGluZycgKSAsXG4gICAgXCJdLXRoZW4tYW55dGhpbmdcIiA6IHJlY3Vyc2UoJ2NtZGFmdGVyJywgJ10tdGhlbi1hbnl0aGluZycgKSAsXG4gICAgXCJub3RoaW5nXCIgOiAoKSA9PiBlbXB0eSAsXG4gIH0gLFxuXG4gIFwiY21kYWZ0ZXItYnV0LW5vdC1dXCI6IHtcbiAgICBcIm90aGVyY21kXCIgOiByZWN1cnNlKCdjbWRhZnRlci1idXQtbm90LV0nLCAnb3RoZXJjbWQnICkgLFxuICAgIFwic29tZXRoaW5nLWVsc2UtdGhlbi1hbnl0aGluZ1wiIDogcmVjdXJzZSgnY21kYWZ0ZXItYnV0LW5vdC1dJywgJ3NvbWV0aGluZy1lbHNlLXRoZW4tYW55dGhpbmcnICkgLFxuICAgIFwibm90aGluZ1wiIDogKCkgPT4gZW1wdHkgLFxuICB9ICxcblxufSA7XG4iXX0=