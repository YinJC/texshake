'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.shake = undefined;

var _jsItertools = require('@aureooms/js-itertools');

var _jsGrammar = require('@aureooms/js-grammar');

const empty = {
  'type': 'node',
  'nonterminal': 'empty',
  'production': 'main',
  'children': []
};

const err = (nonterminal, production) => () => {
  throw new Error(`${nonterminal}.${production} should have been handled before`);
};

const t = _jsGrammar.ast.transform;
const m = (children, match, ctx) => _jsGrammar.ast.cmap(child => t(child, match, ctx), children);

const recurse = (nonterminal, production) => (tree, match, ctx) => ({
  "type": "node",
  nonterminal,
  production,
  "children": m(tree.children, match, ctx)
});

const shake = exports.shake = {

  "anything": {
    "starts-with-othercmd": recurse('anything', 'starts-with-othercmd'),
    "starts-with-*": recurse('anything', 'starts-with-*'),
    "starts-with-[": recurse('anything', 'starts-with-['),
    "starts-with-]": recurse('anything', 'starts-with-]'),
    "starts-with-a-group": recurse('anything', 'starts-with-a-group'),
    "starts-with-something-else": recurse('anything', 'starts-with-something-else'),
    "end": () => empty
  },

  "anything-but-]": {
    "starts-with-othercmd": recurse('anything-but-]', 'starts-with-othercmd'),
    "starts-with-*": recurse('anything', 'starts-with-*'),
    "starts-with-[": recurse('anything', 'starts-with-['),
    "starts-with-a-group": recurse('anything-but-]', 'starts-with-a-group'),
    "starts-with-something-else": recurse('anything-but-]', 'starts-with-something-else'),
    "end": () => empty
  },

  "group": {
    "group": (tree, match, ctx) => {
      const [_open, anything, _close] = tree.children;
      return {
        "type": "node",
        "nonterminal": "group",
        "production": "group",
        "children": (0, _jsItertools.chain)([[_open], m([anything], match, ctx), [_close]])
      };
    }
  },

  "optgroup": {
    "group": (tree, match, ctx) => {
      const [_open, anything, _close] = tree.children;
      return {
        "type": "node",
        "nonterminal": "optgroup",
        "production": "group",
        "children": (0, _jsItertools.chain)([[_open], m([anything], match, ctx), [_close]])
      };
    }
  },

  "othercmd": {

    "othercmd": (tree, match, ctx) => {
      const [othercmd, optstar, args] = tree.children;
      let cmd = othercmd.buffer;
      if (optstar.production === 'yes') cmd += '*';
      const cmdargs = [];
      let arg_i = args;
      while (arg_i.production === 'normal') {
        const [group, argstail] = arg_i.children;
        const [_open, arg, _close] = group.children;
        cmdargs.push(arg);
        arg_i = argstail;
      }
      const hasoptargs = arg_i.production === 'optional';
      if (!hasoptargs && ctx.variables.has(cmd)) {
        // too hard to parse opt args currently
        const [nargs, expandsto] = ctx.variables.get(cmd);
        if (cmdargs.length !== nargs) throw new Error(`Command ${cmd} is defined with ${nargs} arguments but ${cmdargs.length} were given.`);
        return t(expandsto, match, { variables: ctx.variables, args: [ctx.args, cmdargs] });
      } else return {
        'type': 'node',
        'nonterminal': 'othercmd',
        'production': 'othercmd',
        'children': (0, _jsItertools.chain)([[othercmd, optstar], m([args], match, ctx)])
      };
    }

  },

  "*": {
    "*": tree => tree
  },

  "[": {
    "[": tree => tree
  },

  "]": {
    "]": tree => tree
  },

  "something-else": {

    "text": tree => tree,

    "newif": () => empty,

    "ifcmd": (tree, match, ctx) => {

      const [ifcmd, block1, endif] = tree.children;
      const variable = ifcmd.buffer.substr(3);

      if (ctx.variables.has(variable)) {
        const flag = ctx.variables.get(variable);
        if (flag) return t(block1, match, ctx);else if (endif.production === "elsefi") {
          const [_else, block2, _fi] = endif.children;
          return t(block2, match, ctx);
        } else return empty;
      }

      return {
        'type': 'node',
        'nonterminal': 'something-else',
        'production': 'ifcmd',
        'children': (0, _jsItertools.chain)([[ifcmd], m([block1, endif], match, ctx)])
      };
    },

    "falsecmd": (tree, _, ctx) => {
      const [falsecmd] = tree.children;
      const buffer = falsecmd.buffer;
      const variable = buffer.substring(1, buffer.length - 5);
      ctx.variables.set(variable, false);
      return empty;
    },

    "truecmd": (tree, _, ctx) => {
      const [truecmd] = tree.children;
      const buffer = truecmd.buffer;
      const variable = buffer.substring(1, buffer.length - 4);
      ctx.variables.set(variable, true);
      return empty;
    },

    "comment": () => ({
      'type': 'leaf',
      'terminal': 'comment',
      'buffer': '%'
    }),

    "def": (tree, match, { variables }) => {
      const [def, othercmd, _2, anything, _3] = tree.children;
      const cmd = othercmd.buffer;
      variables.set(cmd, [0, _jsGrammar.ast.materialize(anything)]);
      return empty;
    },

    "newcommand": (tree, match, ctx) => {
      const [newcommand, cmddef] = tree.children;
      return t(cmddef, match, ctx);
    },

    " ": tree => tree,
    "\t": tree => tree,
    "\n": tree => tree,

    "arg": (tree, match, { args, variables }) => {
      const [arg] = tree.children;
      if (args.length < 2) throw new Error(`Requesting ${arg} but got no arguments in context.`);
      const i = parseInt(arg.buffer.substr(1), 10) - 1; // #arg
      if (i >= args[1].length) throw new Error(`Requesting ${arg} but only got ${args[1].length} arguments.`);
      const subtree = args[1][i]; // arg
      return t(subtree, match, { args: args[0], variables });
    },

    "$": tree => tree,

    "math": (tree, match, ctx) => {
      const [_open, anything, _close] = tree.children;
      return {
        "type": "node",
        "nonterminal": 'something-else',
        "production": "math",
        "children": (0, _jsItertools.chain)([[_open], m([anything], match, ctx), [_close]])
      };
    },

    "mathenv": (tree, match, ctx) => {
      const [_open, anything, _close] = tree.children;
      return {
        "type": "node",
        "nonterminal": 'something-else',
        "production": "mathenv",
        "children": (0, _jsItertools.chain)([[_open], m([anything], match, ctx), [_close]])
      };
    }

  },

  "endif": {

    "elsefi": (tree, match, ctx) => {
      const [_else, anything, _fi] = tree.children;
      return {
        "type": "node",
        "nonterminal": "endif",
        "production": "elsefi",
        "children": (0, _jsItertools.chain)([[_else], m([anything], match, ctx), [_fi]])
      };
    },

    "fi": tree => tree

  },

  "cmddef": {

    "{cmd}[x]{anything}": (tree, _, { variables }) => {
      const [_0, othercmd, _1, cmddefargs, _2, anything, _3] = tree.children;
      const cmd = othercmd.buffer;
      let nargs = 0;
      if (cmddefargs.production === 'yes') {
        const [_4, text, _5] = cmddefargs.children;
        nargs = parseInt(text.buffer, 10);
      }
      variables.set(cmd, [nargs, anything]);
      return empty;
    },

    "cmd[x]{anything}": (tree, _, { variables }) => {
      const [othercmd, cmddefargs, _2, anything, _3] = tree.children;
      const cmd = othercmd.buffer;
      let nargs = 0;
      if (cmddefargs.production === 'yes') {
        const [_4, text, _5] = cmddefargs.children;
        nargs = parseInt(text.buffer, 10);
      }
      variables.set(cmd, [nargs, anything]);
      return empty;
    },

    "*cmd[x]{anything}": (tree, _, { variables }) => {
      // do not know what to do with '*' at the moment
      const [_1, othercmd, cmddefargs, _2, anything, _3] = tree.children;
      const cmd = othercmd.buffer;
      let nargs = 0;
      if (cmddefargs.production === 'yes') {
        const [_4, text, _5] = cmddefargs.children;
        nargs = parseInt(text.buffer, 10);
      }
      variables.set(cmd, [nargs, anything]);
      return empty;
    }

  },

  "cmddefargs": {
    "yes": err("cmddefargs", "yes"),
    "no": err("cmddefargs", "no")
  },

  "cmd*": {
    "yes": err("cmd*", "yes"),
    "no": err("cmd*", "no")
  },

  "cmdargs": {
    "normal": recurse('cmdargs', 'normal'),
    "optional": recurse('cmdargs', 'optional'),
    "end": () => empty
  },

  "cmdafter": {
    "othercmd": recurse('cmdafter', 'othercmd'),
    "something-else-then-anything": recurse('cmdafter', 'something-else-then-anything'),
    "]-then-anything": recurse('cmdafter', ']-then-anything'),
    "nothing": () => empty
  },

  "cmdafter-but-not-]": {
    "othercmd": recurse('cmdafter-but-not-]', 'othercmd'),
    "something-else-then-anything": recurse('cmdafter-but-not-]', 'something-else-then-anything'),
    "nothing": () => empty
  }

};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zaGFrZS5qcyJdLCJuYW1lcyI6WyJlbXB0eSIsImVyciIsIm5vbnRlcm1pbmFsIiwicHJvZHVjdGlvbiIsIkVycm9yIiwidCIsImFzdCIsInRyYW5zZm9ybSIsIm0iLCJjaGlsZHJlbiIsIm1hdGNoIiwiY3R4IiwiY21hcCIsImNoaWxkIiwicmVjdXJzZSIsInRyZWUiLCJzaGFrZSIsIl9vcGVuIiwiYW55dGhpbmciLCJfY2xvc2UiLCJvdGhlcmNtZCIsIm9wdHN0YXIiLCJhcmdzIiwiY21kIiwiYnVmZmVyIiwiY21kYXJncyIsImFyZ19pIiwiZ3JvdXAiLCJhcmdzdGFpbCIsImFyZyIsInB1c2giLCJoYXNvcHRhcmdzIiwidmFyaWFibGVzIiwiaGFzIiwibmFyZ3MiLCJleHBhbmRzdG8iLCJnZXQiLCJsZW5ndGgiLCJpZmNtZCIsImJsb2NrMSIsImVuZGlmIiwidmFyaWFibGUiLCJzdWJzdHIiLCJmbGFnIiwiX2Vsc2UiLCJibG9jazIiLCJfZmkiLCJfIiwiZmFsc2VjbWQiLCJzdWJzdHJpbmciLCJzZXQiLCJ0cnVlY21kIiwiZGVmIiwiXzIiLCJfMyIsIm1hdGVyaWFsaXplIiwibmV3Y29tbWFuZCIsImNtZGRlZiIsImkiLCJwYXJzZUludCIsInN1YnRyZWUiLCJfMCIsIl8xIiwiY21kZGVmYXJncyIsIl80IiwidGV4dCIsIl81Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUEsTUFBTUEsUUFBUTtBQUNaLFVBQVMsTUFERztBQUVaLGlCQUFnQixPQUZKO0FBR1osZ0JBQWUsTUFISDtBQUlaLGNBQWE7QUFKRCxDQUFkOztBQU9BLE1BQU1DLE1BQU0sQ0FBRUMsV0FBRixFQUFnQkMsVUFBaEIsS0FBZ0MsTUFBTTtBQUNoRCxRQUFNLElBQUlDLEtBQUosQ0FBVyxHQUFFRixXQUFZLElBQUdDLFVBQVcsa0NBQXZDLENBQU47QUFDRCxDQUZEOztBQUlBLE1BQU1FLElBQUlDLGVBQUlDLFNBQWQ7QUFDQSxNQUFNQyxJQUFJLENBQUVDLFFBQUYsRUFBYUMsS0FBYixFQUFxQkMsR0FBckIsS0FBOEJMLGVBQUlNLElBQUosQ0FBVUMsU0FBU1IsRUFBR1EsS0FBSCxFQUFXSCxLQUFYLEVBQW1CQyxHQUFuQixDQUFuQixFQUE4Q0YsUUFBOUMsQ0FBeEM7O0FBRUEsTUFBTUssVUFBVSxDQUFFWixXQUFGLEVBQWdCQyxVQUFoQixLQUFnQyxDQUFFWSxJQUFGLEVBQVNMLEtBQVQsRUFBaUJDLEdBQWpCLE1BQTJCO0FBQ3pFLFVBQVMsTUFEZ0U7QUFFekVULGFBRnlFO0FBR3pFQyxZQUh5RTtBQUl6RSxjQUFhSyxFQUFHTyxLQUFLTixRQUFSLEVBQW1CQyxLQUFuQixFQUEyQkMsR0FBM0I7QUFKNEQsQ0FBM0IsQ0FBaEQ7O0FBUU8sTUFBTUssd0JBQVE7O0FBRW5CLGNBQWE7QUFDWCw0QkFBeUJGLFFBQVMsVUFBVCxFQUFzQixzQkFBdEIsQ0FEZDtBQUVYLHFCQUFrQkEsUUFBUyxVQUFULEVBQXNCLGVBQXRCLENBRlA7QUFHWCxxQkFBa0JBLFFBQVMsVUFBVCxFQUFzQixlQUF0QixDQUhQO0FBSVgscUJBQWtCQSxRQUFTLFVBQVQsRUFBc0IsZUFBdEIsQ0FKUDtBQUtYLDJCQUF3QkEsUUFBUyxVQUFULEVBQXNCLHFCQUF0QixDQUxiO0FBTVgsa0NBQStCQSxRQUFTLFVBQVQsRUFBc0IsNEJBQXRCLENBTnBCO0FBT1gsV0FBUSxNQUFNZDtBQVBILEdBRk07O0FBWW5CLG9CQUFtQjtBQUNqQiw0QkFBeUJjLFFBQVMsZ0JBQVQsRUFBNEIsc0JBQTVCLENBRFI7QUFFakIscUJBQWtCQSxRQUFTLFVBQVQsRUFBc0IsZUFBdEIsQ0FGRDtBQUdqQixxQkFBa0JBLFFBQVMsVUFBVCxFQUFzQixlQUF0QixDQUhEO0FBSWpCLDJCQUF3QkEsUUFBUyxnQkFBVCxFQUE0QixxQkFBNUIsQ0FKUDtBQUtqQixrQ0FBK0JBLFFBQVMsZ0JBQVQsRUFBNEIsNEJBQTVCLENBTGQ7QUFNakIsV0FBUSxNQUFNZDtBQU5HLEdBWkE7O0FBcUJuQixXQUFVO0FBQ1IsYUFBVSxDQUFFZSxJQUFGLEVBQVNMLEtBQVQsRUFBaUJDLEdBQWpCLEtBQTBCO0FBQ2xDLFlBQU0sQ0FBRU0sS0FBRixFQUFVQyxRQUFWLEVBQXFCQyxNQUFyQixJQUFnQ0osS0FBS04sUUFBM0M7QUFDQSxhQUFPO0FBQ1osZ0JBQVMsTUFERztBQUVaLHVCQUFnQixPQUZKO0FBR1osc0JBQWUsT0FISDtBQUlaLG9CQUFhLHdCQUFPLENBQUUsQ0FBRVEsS0FBRixDQUFGLEVBQWNULEVBQUcsQ0FBRVUsUUFBRixDQUFILEVBQWtCUixLQUFsQixFQUEwQkMsR0FBMUIsQ0FBZCxFQUFnRCxDQUFFUSxNQUFGLENBQWhELENBQVA7QUFKRCxPQUFQO0FBTUQ7QUFUTyxHQXJCUzs7QUFpQ25CLGNBQWE7QUFDWCxhQUFVLENBQUVKLElBQUYsRUFBU0wsS0FBVCxFQUFpQkMsR0FBakIsS0FBMEI7QUFDbEMsWUFBTSxDQUFFTSxLQUFGLEVBQVVDLFFBQVYsRUFBcUJDLE1BQXJCLElBQWdDSixLQUFLTixRQUEzQztBQUNBLGFBQU87QUFDWixnQkFBUyxNQURHO0FBRVosdUJBQWdCLFVBRko7QUFHWixzQkFBZSxPQUhIO0FBSVosb0JBQWEsd0JBQU8sQ0FBRSxDQUFFUSxLQUFGLENBQUYsRUFBY1QsRUFBRyxDQUFFVSxRQUFGLENBQUgsRUFBa0JSLEtBQWxCLEVBQTBCQyxHQUExQixDQUFkLEVBQWdELENBQUVRLE1BQUYsQ0FBaEQsQ0FBUDtBQUpELE9BQVA7QUFNRDtBQVRVLEdBakNNOztBQTZDbkIsY0FBYTs7QUFFWCxnQkFBWSxDQUFFSixJQUFGLEVBQVNMLEtBQVQsRUFBaUJDLEdBQWpCLEtBQTBCO0FBQ3BDLFlBQU0sQ0FBRVMsUUFBRixFQUFhQyxPQUFiLEVBQXVCQyxJQUF2QixJQUFnQ1AsS0FBS04sUUFBM0M7QUFDQSxVQUFJYyxNQUFNSCxTQUFTSSxNQUFuQjtBQUNBLFVBQUtILFFBQVFsQixVQUFSLEtBQXVCLEtBQTVCLEVBQW9Db0IsT0FBTyxHQUFQO0FBQ3BDLFlBQU1FLFVBQVUsRUFBaEI7QUFDQSxVQUFJQyxRQUFRSixJQUFaO0FBQ0EsYUFBUUksTUFBTXZCLFVBQU4sS0FBcUIsUUFBN0IsRUFBd0M7QUFDN0MsY0FBTSxDQUFFd0IsS0FBRixFQUFVQyxRQUFWLElBQXVCRixNQUFNakIsUUFBbkM7QUFDQSxjQUFNLENBQUVRLEtBQUYsRUFBVVksR0FBVixFQUFnQlYsTUFBaEIsSUFBMkJRLE1BQU1sQixRQUF2QztBQUNBZ0IsZ0JBQVFLLElBQVIsQ0FBYUQsR0FBYjtBQUNBSCxnQkFBUUUsUUFBUjtBQUNNO0FBQ0QsWUFBTUcsYUFBYUwsTUFBTXZCLFVBQU4sS0FBcUIsVUFBeEM7QUFDQSxVQUFJLENBQUM0QixVQUFELElBQWVwQixJQUFJcUIsU0FBSixDQUFjQyxHQUFkLENBQWtCVixHQUFsQixDQUFuQixFQUEyQztBQUNoRDtBQUNBLGNBQU0sQ0FBRVcsS0FBRixFQUFVQyxTQUFWLElBQXdCeEIsSUFBSXFCLFNBQUosQ0FBY0ksR0FBZCxDQUFrQmIsR0FBbEIsQ0FBOUI7QUFDQSxZQUFJRSxRQUFRWSxNQUFSLEtBQW1CSCxLQUF2QixFQUE4QixNQUFNLElBQUk5QixLQUFKLENBQVcsV0FBVW1CLEdBQUksb0JBQW1CVyxLQUFNLGtCQUFpQlQsUUFBUVksTUFBTyxjQUFsRixDQUFOO0FBQzlCLGVBQU9oQyxFQUFHOEIsU0FBSCxFQUFlekIsS0FBZixFQUF1QixFQUFFc0IsV0FBV3JCLElBQUlxQixTQUFqQixFQUE2QlYsTUFBTSxDQUFFWCxJQUFJVyxJQUFOLEVBQWFHLE9BQWIsQ0FBbkMsRUFBdkIsQ0FBUDtBQUNNLE9BTEQsTUFNSyxPQUFPO0FBQ2pCLGdCQUFTLE1BRFE7QUFFakIsdUJBQWdCLFVBRkM7QUFHakIsc0JBQWUsVUFIRTtBQUlqQixvQkFBYSx3QkFBTyxDQUFFLENBQUVMLFFBQUYsRUFBYUMsT0FBYixDQUFGLEVBQTJCYixFQUFFLENBQUNjLElBQUQsQ0FBRixFQUFVWixLQUFWLEVBQWlCQyxHQUFqQixDQUEzQixDQUFQO0FBSkksT0FBUDtBQU1OOztBQTNCVSxHQTdDTTs7QUE0RW5CLE9BQU07QUFDSixTQUFNSSxRQUFRQTtBQURWLEdBNUVhOztBQWdGbkIsT0FBTTtBQUNKLFNBQU1BLFFBQVFBO0FBRFYsR0FoRmE7O0FBb0ZuQixPQUFNO0FBQ0osU0FBTUEsUUFBUUE7QUFEVixHQXBGYTs7QUF3Rm5CLG9CQUFtQjs7QUFFakIsWUFBU0EsUUFBUUEsSUFGQTs7QUFJakIsYUFBUyxNQUFNZixLQUpFOztBQU1qQixhQUFTLENBQUVlLElBQUYsRUFBU0wsS0FBVCxFQUFpQkMsR0FBakIsS0FBMEI7O0FBRWpDLFlBQU0sQ0FBRTJCLEtBQUYsRUFBVUMsTUFBVixFQUFtQkMsS0FBbkIsSUFBNkJ6QixLQUFLTixRQUF4QztBQUNBLFlBQU1nQyxXQUFXSCxNQUFNZCxNQUFOLENBQWFrQixNQUFiLENBQW9CLENBQXBCLENBQWpCOztBQUVBLFVBQUkvQixJQUFJcUIsU0FBSixDQUFjQyxHQUFkLENBQWtCUSxRQUFsQixDQUFKLEVBQWlDO0FBQ3RDLGNBQU1FLE9BQU9oQyxJQUFJcUIsU0FBSixDQUFjSSxHQUFkLENBQWtCSyxRQUFsQixDQUFiO0FBQ0EsWUFBSUUsSUFBSixFQUFVLE9BQU90QyxFQUFHa0MsTUFBSCxFQUFZN0IsS0FBWixFQUFvQkMsR0FBcEIsQ0FBUCxDQUFWLEtBQ0ssSUFBSzZCLE1BQU1yQyxVQUFOLEtBQXFCLFFBQTFCLEVBQXFDO0FBQ3hDLGdCQUFNLENBQUV5QyxLQUFGLEVBQVVDLE1BQVYsRUFBbUJDLEdBQW5CLElBQTJCTixNQUFNL0IsUUFBdkM7QUFDQSxpQkFBT0osRUFBR3dDLE1BQUgsRUFBWW5DLEtBQVosRUFBb0JDLEdBQXBCLENBQVA7QUFDRCxTQUhJLE1BSUEsT0FBT1gsS0FBUDtBQUNDOztBQUVELGFBQU87QUFDWixnQkFBUyxNQURHO0FBRVosdUJBQWdCLGdCQUZKO0FBR1osc0JBQWUsT0FISDtBQUlaLG9CQUFhLHdCQUFPLENBQUUsQ0FBRXNDLEtBQUYsQ0FBRixFQUFjOUIsRUFBRyxDQUFDK0IsTUFBRCxFQUFTQyxLQUFULENBQUgsRUFBcUI5QixLQUFyQixFQUE2QkMsR0FBN0IsQ0FBZCxDQUFQO0FBSkQsT0FBUDtBQU9ELEtBNUJnQjs7QUE4QmpCLGdCQUFhLENBQUVJLElBQUYsRUFBU2dDLENBQVQsRUFBYXBDLEdBQWIsS0FBc0I7QUFDakMsWUFBTSxDQUFFcUMsUUFBRixJQUFlakMsS0FBS04sUUFBMUI7QUFDQSxZQUFNZSxTQUFTd0IsU0FBU3hCLE1BQXhCO0FBQ0EsWUFBTWlCLFdBQVdqQixPQUFPeUIsU0FBUCxDQUFpQixDQUFqQixFQUFvQnpCLE9BQU9hLE1BQVAsR0FBYyxDQUFsQyxDQUFqQjtBQUNBMUIsVUFBSXFCLFNBQUosQ0FBY2tCLEdBQWQsQ0FBa0JULFFBQWxCLEVBQTRCLEtBQTVCO0FBQ0EsYUFBT3pDLEtBQVA7QUFDRCxLQXBDZ0I7O0FBc0NqQixlQUFZLENBQUVlLElBQUYsRUFBU2dDLENBQVQsRUFBYXBDLEdBQWIsS0FBc0I7QUFDaEMsWUFBTSxDQUFFd0MsT0FBRixJQUFjcEMsS0FBS04sUUFBekI7QUFDQSxZQUFNZSxTQUFTMkIsUUFBUTNCLE1BQXZCO0FBQ0EsWUFBTWlCLFdBQVdqQixPQUFPeUIsU0FBUCxDQUFpQixDQUFqQixFQUFvQnpCLE9BQU9hLE1BQVAsR0FBYyxDQUFsQyxDQUFqQjtBQUNBMUIsVUFBSXFCLFNBQUosQ0FBY2tCLEdBQWQsQ0FBa0JULFFBQWxCLEVBQTRCLElBQTVCO0FBQ0EsYUFBT3pDLEtBQVA7QUFDRCxLQTVDZ0I7O0FBOENqQixlQUFXLE9BQVE7QUFDakIsY0FBUyxNQURRO0FBRWpCLGtCQUFhLFNBRkk7QUFHakIsZ0JBQVc7QUFITSxLQUFSLENBOUNNOztBQW9EakIsV0FBTyxDQUFFZSxJQUFGLEVBQVNMLEtBQVQsRUFBaUIsRUFBRXNCLFNBQUYsRUFBakIsS0FBb0M7QUFDekMsWUFBTSxDQUFFb0IsR0FBRixFQUFRaEMsUUFBUixFQUFtQmlDLEVBQW5CLEVBQXdCbkMsUUFBeEIsRUFBbUNvQyxFQUFuQyxJQUEwQ3ZDLEtBQUtOLFFBQXJEO0FBQ0EsWUFBTWMsTUFBTUgsU0FBU0ksTUFBckI7QUFDQVEsZ0JBQVVrQixHQUFWLENBQWMzQixHQUFkLEVBQW1CLENBQUMsQ0FBRCxFQUFJakIsZUFBSWlELFdBQUosQ0FBZ0JyQyxRQUFoQixDQUFKLENBQW5CO0FBQ0EsYUFBT2xCLEtBQVA7QUFDRCxLQXpEZ0I7O0FBMkRqQixrQkFBYyxDQUFFZSxJQUFGLEVBQVNMLEtBQVQsRUFBaUJDLEdBQWpCLEtBQTBCO0FBQ3RDLFlBQU0sQ0FBRTZDLFVBQUYsRUFBZUMsTUFBZixJQUEwQjFDLEtBQUtOLFFBQXJDO0FBQ0EsYUFBT0osRUFBR29ELE1BQUgsRUFBWS9DLEtBQVosRUFBb0JDLEdBQXBCLENBQVA7QUFDRCxLQTlEZ0I7O0FBZ0VqQixTQUFNSSxRQUFRQSxJQWhFRztBQWlFakIsVUFBT0EsUUFBUUEsSUFqRUU7QUFrRWpCLFVBQU9BLFFBQVFBLElBbEVFOztBQW9FakIsV0FBTyxDQUFFQSxJQUFGLEVBQVNMLEtBQVQsRUFBaUIsRUFBRVksSUFBRixFQUFTVSxTQUFULEVBQWpCLEtBQTJDO0FBQ2hELFlBQU0sQ0FBRUgsR0FBRixJQUFVZCxLQUFLTixRQUFyQjtBQUNBLFVBQUthLEtBQUtlLE1BQUwsR0FBYyxDQUFuQixFQUF1QixNQUFNLElBQUlqQyxLQUFKLENBQVcsY0FBYXlCLEdBQUksbUNBQTVCLENBQU47QUFDdkIsWUFBTTZCLElBQUlDLFNBQVM5QixJQUFJTCxNQUFKLENBQVdrQixNQUFYLENBQWtCLENBQWxCLENBQVQsRUFBK0IsRUFBL0IsSUFBcUMsQ0FBL0MsQ0FIZ0QsQ0FHRTtBQUNsRCxVQUFLZ0IsS0FBS3BDLEtBQUssQ0FBTCxFQUFRZSxNQUFsQixFQUEyQixNQUFNLElBQUlqQyxLQUFKLENBQVcsY0FBYXlCLEdBQUksaUJBQWdCUCxLQUFLLENBQUwsRUFBUWUsTUFBTyxhQUEzRCxDQUFOO0FBQzNCLFlBQU11QixVQUFVdEMsS0FBSyxDQUFMLEVBQVFvQyxDQUFSLENBQWhCLENBTGdELENBS25CO0FBQzdCLGFBQU9yRCxFQUFHdUQsT0FBSCxFQUFhbEQsS0FBYixFQUFxQixFQUFFWSxNQUFNQSxLQUFLLENBQUwsQ0FBUixFQUFrQlUsU0FBbEIsRUFBckIsQ0FBUDtBQUNELEtBM0VnQjs7QUE2RWpCLFNBQU1qQixRQUFRQSxJQTdFRzs7QUErRWpCLFlBQVMsQ0FBRUEsSUFBRixFQUFTTCxLQUFULEVBQWlCQyxHQUFqQixLQUEwQjtBQUNqQyxZQUFNLENBQUVNLEtBQUYsRUFBVUMsUUFBVixFQUFxQkMsTUFBckIsSUFBZ0NKLEtBQUtOLFFBQTNDO0FBQ0EsYUFBTztBQUNaLGdCQUFTLE1BREc7QUFFWix1QkFBZ0IsZ0JBRko7QUFHWixzQkFBZSxNQUhIO0FBSVosb0JBQWEsd0JBQU8sQ0FBRSxDQUFFUSxLQUFGLENBQUYsRUFBY1QsRUFBRyxDQUFFVSxRQUFGLENBQUgsRUFBa0JSLEtBQWxCLEVBQTBCQyxHQUExQixDQUFkLEVBQWdELENBQUVRLE1BQUYsQ0FBaEQsQ0FBUDtBQUpELE9BQVA7QUFNRCxLQXZGZ0I7O0FBeUZqQixlQUFZLENBQUVKLElBQUYsRUFBU0wsS0FBVCxFQUFpQkMsR0FBakIsS0FBMEI7QUFDcEMsWUFBTSxDQUFFTSxLQUFGLEVBQVVDLFFBQVYsRUFBcUJDLE1BQXJCLElBQWdDSixLQUFLTixRQUEzQztBQUNBLGFBQU87QUFDWixnQkFBUyxNQURHO0FBRVosdUJBQWdCLGdCQUZKO0FBR1osc0JBQWUsU0FISDtBQUlaLG9CQUFhLHdCQUFPLENBQUUsQ0FBRVEsS0FBRixDQUFGLEVBQWNULEVBQUcsQ0FBRVUsUUFBRixDQUFILEVBQWtCUixLQUFsQixFQUEwQkMsR0FBMUIsQ0FBZCxFQUFnRCxDQUFFUSxNQUFGLENBQWhELENBQVA7QUFKRCxPQUFQO0FBTUQ7O0FBakdnQixHQXhGQTs7QUE2TG5CLFdBQVM7O0FBRVAsY0FBVyxDQUFFSixJQUFGLEVBQVNMLEtBQVQsRUFBaUJDLEdBQWpCLEtBQTBCO0FBQ25DLFlBQU0sQ0FBRWlDLEtBQUYsRUFBVTFCLFFBQVYsRUFBcUI0QixHQUFyQixJQUE2Qi9CLEtBQUtOLFFBQXhDO0FBQ0EsYUFBTztBQUNaLGdCQUFTLE1BREc7QUFFWix1QkFBZ0IsT0FGSjtBQUdaLHNCQUFlLFFBSEg7QUFJWixvQkFBYSx3QkFBTSxDQUFFLENBQUVtQyxLQUFGLENBQUYsRUFBY3BDLEVBQUcsQ0FBRVUsUUFBRixDQUFILEVBQWtCUixLQUFsQixFQUEwQkMsR0FBMUIsQ0FBZCxFQUFnRCxDQUFFbUMsR0FBRixDQUFoRCxDQUFOO0FBSkQsT0FBUDtBQU1ELEtBVk07O0FBWVAsVUFBTy9CLFFBQVFBOztBQVpSLEdBN0xVOztBQTZNbkIsWUFBVzs7QUFFVCwwQkFBc0IsQ0FBRUEsSUFBRixFQUFTZ0MsQ0FBVCxFQUFhLEVBQUVmLFNBQUYsRUFBYixLQUFnQztBQUNwRCxZQUFNLENBQUU2QixFQUFGLEVBQU96QyxRQUFQLEVBQWtCMEMsRUFBbEIsRUFBdUJDLFVBQXZCLEVBQW9DVixFQUFwQyxFQUF5Q25DLFFBQXpDLEVBQW9Eb0MsRUFBcEQsSUFBMkR2QyxLQUFLTixRQUF0RTtBQUNBLFlBQU1jLE1BQU1ILFNBQVNJLE1BQXJCO0FBQ0EsVUFBSVUsUUFBUSxDQUFaO0FBQ0EsVUFBSTZCLFdBQVc1RCxVQUFYLEtBQTBCLEtBQTlCLEVBQXFDO0FBQzFDLGNBQU0sQ0FBRTZELEVBQUYsRUFBT0MsSUFBUCxFQUFjQyxFQUFkLElBQXFCSCxXQUFXdEQsUUFBdEM7QUFDQXlCLGdCQUFReUIsU0FBU00sS0FBS3pDLE1BQWQsRUFBc0IsRUFBdEIsQ0FBUjtBQUNNO0FBQ0RRLGdCQUFVa0IsR0FBVixDQUFjM0IsR0FBZCxFQUFtQixDQUFFVyxLQUFGLEVBQVVoQixRQUFWLENBQW5CO0FBQ0EsYUFBT2xCLEtBQVA7QUFDRCxLQVpROztBQWNULHdCQUFvQixDQUFFZSxJQUFGLEVBQVNnQyxDQUFULEVBQWEsRUFBRWYsU0FBRixFQUFiLEtBQWdDO0FBQ2xELFlBQU0sQ0FBRVosUUFBRixFQUFhMkMsVUFBYixFQUEwQlYsRUFBMUIsRUFBK0JuQyxRQUEvQixFQUEwQ29DLEVBQTFDLElBQWlEdkMsS0FBS04sUUFBNUQ7QUFDQSxZQUFNYyxNQUFNSCxTQUFTSSxNQUFyQjtBQUNBLFVBQUlVLFFBQVEsQ0FBWjtBQUNBLFVBQUk2QixXQUFXNUQsVUFBWCxLQUEwQixLQUE5QixFQUFxQztBQUMxQyxjQUFNLENBQUU2RCxFQUFGLEVBQU9DLElBQVAsRUFBY0MsRUFBZCxJQUFxQkgsV0FBV3RELFFBQXRDO0FBQ0F5QixnQkFBUXlCLFNBQVNNLEtBQUt6QyxNQUFkLEVBQXNCLEVBQXRCLENBQVI7QUFDTTtBQUNEUSxnQkFBVWtCLEdBQVYsQ0FBYzNCLEdBQWQsRUFBbUIsQ0FBRVcsS0FBRixFQUFVaEIsUUFBVixDQUFuQjtBQUNBLGFBQU9sQixLQUFQO0FBQ0QsS0F4QlE7O0FBMEJULHlCQUFxQixDQUFFZSxJQUFGLEVBQVNnQyxDQUFULEVBQWEsRUFBRWYsU0FBRixFQUFiLEtBQWdDO0FBQ25EO0FBQ0EsWUFBTSxDQUFFOEIsRUFBRixFQUFPMUMsUUFBUCxFQUFrQjJDLFVBQWxCLEVBQStCVixFQUEvQixFQUFvQ25DLFFBQXBDLEVBQStDb0MsRUFBL0MsSUFBc0R2QyxLQUFLTixRQUFqRTtBQUNBLFlBQU1jLE1BQU1ILFNBQVNJLE1BQXJCO0FBQ0EsVUFBSVUsUUFBUSxDQUFaO0FBQ0EsVUFBSTZCLFdBQVc1RCxVQUFYLEtBQTBCLEtBQTlCLEVBQXFDO0FBQzFDLGNBQU0sQ0FBRTZELEVBQUYsRUFBT0MsSUFBUCxFQUFjQyxFQUFkLElBQXFCSCxXQUFXdEQsUUFBdEM7QUFDQXlCLGdCQUFReUIsU0FBU00sS0FBS3pDLE1BQWQsRUFBc0IsRUFBdEIsQ0FBUjtBQUNNO0FBQ0RRLGdCQUFVa0IsR0FBVixDQUFjM0IsR0FBZCxFQUFtQixDQUFFVyxLQUFGLEVBQVVoQixRQUFWLENBQW5CO0FBQ0EsYUFBT2xCLEtBQVA7QUFDRDs7QUFyQ1EsR0E3TVE7O0FBc1BuQixnQkFBYztBQUNaLFdBQVFDLElBQUssWUFBTCxFQUFvQixLQUFwQixDQURJO0FBRVosVUFBT0EsSUFBSyxZQUFMLEVBQW9CLElBQXBCO0FBRkssR0F0UEs7O0FBMlBuQixVQUFRO0FBQ04sV0FBUUEsSUFBSyxNQUFMLEVBQWMsS0FBZCxDQURGO0FBRU4sVUFBT0EsSUFBSyxNQUFMLEVBQWMsSUFBZDtBQUZELEdBM1BXOztBQWdRbkIsYUFBVztBQUNULGNBQVdhLFFBQVEsU0FBUixFQUFtQixRQUFuQixDQURGO0FBRVQsZ0JBQWFBLFFBQVEsU0FBUixFQUFtQixVQUFuQixDQUZKO0FBR1QsV0FBUSxNQUFNZDtBQUhMLEdBaFFROztBQXNRbkIsY0FBWTtBQUNWLGdCQUFhYyxRQUFRLFVBQVIsRUFBb0IsVUFBcEIsQ0FESDtBQUVWLG9DQUFpQ0EsUUFBUSxVQUFSLEVBQW9CLDhCQUFwQixDQUZ2QjtBQUdWLHVCQUFvQkEsUUFBUSxVQUFSLEVBQW9CLGlCQUFwQixDQUhWO0FBSVYsZUFBWSxNQUFNZDtBQUpSLEdBdFFPOztBQTZRbkIsd0JBQXNCO0FBQ3BCLGdCQUFhYyxRQUFRLG9CQUFSLEVBQThCLFVBQTlCLENBRE87QUFFcEIsb0NBQWlDQSxRQUFRLG9CQUFSLEVBQThCLDhCQUE5QixDQUZiO0FBR3BCLGVBQVksTUFBTWQ7QUFIRTs7QUE3UUgsQ0FBZCIsImZpbGUiOiJzaGFrZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNoYWluIH0gZnJvbSAnQGF1cmVvb21zL2pzLWl0ZXJ0b29scycgO1xuaW1wb3J0IHsgYXN0IH0gZnJvbSAnQGF1cmVvb21zL2pzLWdyYW1tYXInIDtcblxuY29uc3QgZW1wdHkgPSB7XG4gICd0eXBlJyA6ICdub2RlJyAsXG4gICdub250ZXJtaW5hbCcgOiAnZW1wdHknICxcbiAgJ3Byb2R1Y3Rpb24nIDogJ21haW4nICxcbiAgJ2NoaWxkcmVuJyA6IFtdICxcbn0gO1xuXG5jb25zdCBlcnIgPSAoIG5vbnRlcm1pbmFsICwgcHJvZHVjdGlvbiApID0+ICgpID0+IHtcbiAgdGhyb3cgbmV3IEVycm9yKGAke25vbnRlcm1pbmFsfS4ke3Byb2R1Y3Rpb259IHNob3VsZCBoYXZlIGJlZW4gaGFuZGxlZCBiZWZvcmVgKTtcbn0gO1xuXG5jb25zdCB0ID0gYXN0LnRyYW5zZm9ybSA7XG5jb25zdCBtID0gKCBjaGlsZHJlbiAsIG1hdGNoICwgY3R4ICkgPT4gYXN0LmNtYXAoIGNoaWxkID0+IHQoIGNoaWxkICwgbWF0Y2ggLCBjdHggKSAsIGNoaWxkcmVuICkgO1xuXG5jb25zdCByZWN1cnNlID0gKCBub250ZXJtaW5hbCAsIHByb2R1Y3Rpb24gKSA9PiAoIHRyZWUgLCBtYXRjaCAsIGN0eCApID0+ICh7XG4gIFwidHlwZVwiIDogXCJub2RlXCIgLFxuICBub250ZXJtaW5hbCAsXG4gIHByb2R1Y3Rpb24gLFxuICBcImNoaWxkcmVuXCIgOiBtKCB0cmVlLmNoaWxkcmVuICwgbWF0Y2ggLCBjdHggKSAsXG59KSA7XG5cblxuZXhwb3J0IGNvbnN0IHNoYWtlID0ge1xuXG4gIFwiYW55dGhpbmdcIiA6IHtcbiAgICBcInN0YXJ0cy13aXRoLW90aGVyY21kXCIgOiByZWN1cnNlKCAnYW55dGhpbmcnICwgJ3N0YXJ0cy13aXRoLW90aGVyY21kJyApICxcbiAgICBcInN0YXJ0cy13aXRoLSpcIiA6IHJlY3Vyc2UoICdhbnl0aGluZycgLCAnc3RhcnRzLXdpdGgtKicgKSAsXG4gICAgXCJzdGFydHMtd2l0aC1bXCIgOiByZWN1cnNlKCAnYW55dGhpbmcnICwgJ3N0YXJ0cy13aXRoLVsnICkgLFxuICAgIFwic3RhcnRzLXdpdGgtXVwiIDogcmVjdXJzZSggJ2FueXRoaW5nJyAsICdzdGFydHMtd2l0aC1dJyApICxcbiAgICBcInN0YXJ0cy13aXRoLWEtZ3JvdXBcIiA6IHJlY3Vyc2UoICdhbnl0aGluZycgLCAnc3RhcnRzLXdpdGgtYS1ncm91cCcgKSAsXG4gICAgXCJzdGFydHMtd2l0aC1zb21ldGhpbmctZWxzZVwiIDogcmVjdXJzZSggJ2FueXRoaW5nJyAsICdzdGFydHMtd2l0aC1zb21ldGhpbmctZWxzZScgKSAsXG4gICAgXCJlbmRcIiA6ICgpID0+IGVtcHR5ICxcbiAgfSAsXG5cbiAgXCJhbnl0aGluZy1idXQtXVwiIDoge1xuICAgIFwic3RhcnRzLXdpdGgtb3RoZXJjbWRcIiA6IHJlY3Vyc2UoICdhbnl0aGluZy1idXQtXScgLCAnc3RhcnRzLXdpdGgtb3RoZXJjbWQnICkgLFxuICAgIFwic3RhcnRzLXdpdGgtKlwiIDogcmVjdXJzZSggJ2FueXRoaW5nJyAsICdzdGFydHMtd2l0aC0qJyApICxcbiAgICBcInN0YXJ0cy13aXRoLVtcIiA6IHJlY3Vyc2UoICdhbnl0aGluZycgLCAnc3RhcnRzLXdpdGgtWycgKSAsXG4gICAgXCJzdGFydHMtd2l0aC1hLWdyb3VwXCIgOiByZWN1cnNlKCAnYW55dGhpbmctYnV0LV0nICwgJ3N0YXJ0cy13aXRoLWEtZ3JvdXAnICkgLFxuICAgIFwic3RhcnRzLXdpdGgtc29tZXRoaW5nLWVsc2VcIiA6IHJlY3Vyc2UoICdhbnl0aGluZy1idXQtXScgLCAnc3RhcnRzLXdpdGgtc29tZXRoaW5nLWVsc2UnICkgLFxuICAgIFwiZW5kXCIgOiAoKSA9PiBlbXB0eSAsXG4gIH0gLFxuXG4gIFwiZ3JvdXBcIiA6IHtcbiAgICBcImdyb3VwXCIgOiAoIHRyZWUgLCBtYXRjaCAsIGN0eCApID0+IHtcbiAgICAgIGNvbnN0IFsgX29wZW4gLCBhbnl0aGluZyAsIF9jbG9zZSBdID0gdHJlZS5jaGlsZHJlbiA7XG4gICAgICByZXR1cm4ge1xuXHRcInR5cGVcIiA6IFwibm9kZVwiICxcblx0XCJub250ZXJtaW5hbFwiIDogXCJncm91cFwiICxcblx0XCJwcm9kdWN0aW9uXCIgOiBcImdyb3VwXCIgLFxuXHRcImNoaWxkcmVuXCIgOiBjaGFpbiggWyBbIF9vcGVuIF0gLCBtKCBbIGFueXRoaW5nIF0gLCBtYXRjaCAsIGN0eCApICwgWyBfY2xvc2UgXSBdICkgLFxuICAgICAgfSA7XG4gICAgfSAsXG4gIH0gLFxuXG4gIFwib3B0Z3JvdXBcIiA6IHtcbiAgICBcImdyb3VwXCIgOiAoIHRyZWUgLCBtYXRjaCAsIGN0eCApID0+IHtcbiAgICAgIGNvbnN0IFsgX29wZW4gLCBhbnl0aGluZyAsIF9jbG9zZSBdID0gdHJlZS5jaGlsZHJlbiA7XG4gICAgICByZXR1cm4ge1xuXHRcInR5cGVcIiA6IFwibm9kZVwiICxcblx0XCJub250ZXJtaW5hbFwiIDogXCJvcHRncm91cFwiICxcblx0XCJwcm9kdWN0aW9uXCIgOiBcImdyb3VwXCIgLFxuXHRcImNoaWxkcmVuXCIgOiBjaGFpbiggWyBbIF9vcGVuIF0gLCBtKCBbIGFueXRoaW5nIF0gLCBtYXRjaCAsIGN0eCApICwgWyBfY2xvc2UgXSBdICkgLFxuICAgICAgfSA7XG4gICAgfSAsXG4gIH0gLFxuXG4gIFwib3RoZXJjbWRcIiA6IHtcblxuICAgIFwib3RoZXJjbWRcIjogKCB0cmVlICwgbWF0Y2ggLCBjdHggKSA9PiB7XG4gICAgICBjb25zdCBbIG90aGVyY21kICwgb3B0c3RhciAsIGFyZ3MgXSA9IHRyZWUuY2hpbGRyZW4gO1xuICAgICAgbGV0IGNtZCA9IG90aGVyY21kLmJ1ZmZlcjtcbiAgICAgIGlmICggb3B0c3Rhci5wcm9kdWN0aW9uID09PSAneWVzJyApIGNtZCArPSAnKic7XG4gICAgICBjb25zdCBjbWRhcmdzID0gW107XG4gICAgICBsZXQgYXJnX2kgPSBhcmdzXG4gICAgICB3aGlsZSAoIGFyZ19pLnByb2R1Y3Rpb24gPT09ICdub3JtYWwnICkge1xuXHRjb25zdCBbIGdyb3VwICwgYXJnc3RhaWwgXSA9IGFyZ19pLmNoaWxkcmVuIDtcblx0Y29uc3QgWyBfb3BlbiAsIGFyZyAsIF9jbG9zZSBdID0gZ3JvdXAuY2hpbGRyZW4gO1xuXHRjbWRhcmdzLnB1c2goYXJnKSA7XG5cdGFyZ19pID0gYXJnc3RhaWwgO1xuICAgICAgfVxuICAgICAgY29uc3QgaGFzb3B0YXJncyA9IGFyZ19pLnByb2R1Y3Rpb24gPT09ICdvcHRpb25hbCcgO1xuICAgICAgaWYgKCFoYXNvcHRhcmdzICYmIGN0eC52YXJpYWJsZXMuaGFzKGNtZCkpIHtcblx0Ly8gdG9vIGhhcmQgdG8gcGFyc2Ugb3B0IGFyZ3MgY3VycmVudGx5XG5cdGNvbnN0IFsgbmFyZ3MgLCBleHBhbmRzdG8gXSA9IGN0eC52YXJpYWJsZXMuZ2V0KGNtZCkgO1xuXHRpZiAoY21kYXJncy5sZW5ndGggIT09IG5hcmdzKSB0aHJvdyBuZXcgRXJyb3IoYENvbW1hbmQgJHtjbWR9IGlzIGRlZmluZWQgd2l0aCAke25hcmdzfSBhcmd1bWVudHMgYnV0ICR7Y21kYXJncy5sZW5ndGh9IHdlcmUgZ2l2ZW4uYCkgO1xuXHRyZXR1cm4gdCggZXhwYW5kc3RvICwgbWF0Y2ggLCB7IHZhcmlhYmxlczogY3R4LnZhcmlhYmxlcyAsIGFyZ3M6IFsgY3R4LmFyZ3MgLCBjbWRhcmdzIF0gfSApIDtcbiAgICAgIH1cbiAgICAgIGVsc2UgcmV0dXJuIHtcblx0J3R5cGUnIDogJ25vZGUnICxcblx0J25vbnRlcm1pbmFsJyA6ICdvdGhlcmNtZCcgLFxuXHQncHJvZHVjdGlvbicgOiAnb3RoZXJjbWQnICxcblx0J2NoaWxkcmVuJyA6IGNoYWluKCBbIFsgb3RoZXJjbWQgLCBvcHRzdGFyIF0gLCBtKFthcmdzXSwgbWF0Y2gsIGN0eCkgXSApICxcbiAgICAgIH0gO1xuICAgIH0gLFxuXG4gIH0gLFxuXG4gIFwiKlwiIDoge1xuICAgIFwiKlwiIDogdHJlZSA9PiB0cmVlICxcbiAgfSAsXG5cbiAgXCJbXCIgOiB7XG4gICAgXCJbXCIgOiB0cmVlID0+IHRyZWUgLFxuICB9ICxcblxuICBcIl1cIiA6IHtcbiAgICBcIl1cIiA6IHRyZWUgPT4gdHJlZSAsXG4gIH0gLFxuXG4gIFwic29tZXRoaW5nLWVsc2VcIiA6IHtcblxuICAgIFwidGV4dFwiIDogdHJlZSA9PiB0cmVlICxcblxuICAgIFwibmV3aWZcIjogKCkgPT4gZW1wdHkgLFxuXG4gICAgXCJpZmNtZFwiOiAoIHRyZWUgLCBtYXRjaCAsIGN0eCApID0+IHtcblxuICAgICAgY29uc3QgWyBpZmNtZCAsIGJsb2NrMSAsIGVuZGlmIF0gPSB0cmVlLmNoaWxkcmVuIDtcbiAgICAgIGNvbnN0IHZhcmlhYmxlID0gaWZjbWQuYnVmZmVyLnN1YnN0cigzKTtcblxuICAgICAgaWYgKGN0eC52YXJpYWJsZXMuaGFzKHZhcmlhYmxlKSkge1xuXHRjb25zdCBmbGFnID0gY3R4LnZhcmlhYmxlcy5nZXQodmFyaWFibGUpO1xuXHRpZiAoZmxhZykgcmV0dXJuIHQoIGJsb2NrMSAsIG1hdGNoICwgY3R4ICkgO1xuXHRlbHNlIGlmICggZW5kaWYucHJvZHVjdGlvbiA9PT0gXCJlbHNlZmlcIiApIHtcblx0ICBjb25zdCBbIF9lbHNlICwgYmxvY2syICwgX2ZpIF0gPSBlbmRpZi5jaGlsZHJlbiA7XG5cdCAgcmV0dXJuIHQoIGJsb2NrMiAsIG1hdGNoICwgY3R4ICkgO1xuXHR9XG5cdGVsc2UgcmV0dXJuIGVtcHR5IDtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcblx0J3R5cGUnIDogJ25vZGUnICxcblx0J25vbnRlcm1pbmFsJyA6ICdzb21ldGhpbmctZWxzZScgLFxuXHQncHJvZHVjdGlvbicgOiAnaWZjbWQnICxcblx0J2NoaWxkcmVuJyA6IGNoYWluKCBbIFsgaWZjbWQgXSAsIG0oIFtibG9jazEsIGVuZGlmXSAsIG1hdGNoICwgY3R4ICkgXSApICxcbiAgICAgIH0gO1xuXG4gICAgfSAsXG5cbiAgICBcImZhbHNlY21kXCIgOiAoIHRyZWUgLCBfICwgY3R4ICkgPT4ge1xuICAgICAgY29uc3QgWyBmYWxzZWNtZCBdID0gdHJlZS5jaGlsZHJlbiA7XG4gICAgICBjb25zdCBidWZmZXIgPSBmYWxzZWNtZC5idWZmZXI7XG4gICAgICBjb25zdCB2YXJpYWJsZSA9IGJ1ZmZlci5zdWJzdHJpbmcoMSwgYnVmZmVyLmxlbmd0aC01KTtcbiAgICAgIGN0eC52YXJpYWJsZXMuc2V0KHZhcmlhYmxlLCBmYWxzZSk7XG4gICAgICByZXR1cm4gZW1wdHk7XG4gICAgfSAsXG5cbiAgICBcInRydWVjbWRcIiA6ICggdHJlZSAsIF8gLCBjdHggKSA9PiB7XG4gICAgICBjb25zdCBbIHRydWVjbWQgXSA9IHRyZWUuY2hpbGRyZW4gO1xuICAgICAgY29uc3QgYnVmZmVyID0gdHJ1ZWNtZC5idWZmZXI7XG4gICAgICBjb25zdCB2YXJpYWJsZSA9IGJ1ZmZlci5zdWJzdHJpbmcoMSwgYnVmZmVyLmxlbmd0aC00KTtcbiAgICAgIGN0eC52YXJpYWJsZXMuc2V0KHZhcmlhYmxlLCB0cnVlKTtcbiAgICAgIHJldHVybiBlbXB0eTtcbiAgICB9ICxcblxuICAgIFwiY29tbWVudFwiOiAoICkgPT4gKHtcbiAgICAgICd0eXBlJyA6ICdsZWFmJyAsXG4gICAgICAndGVybWluYWwnIDogJ2NvbW1lbnQnICxcbiAgICAgICdidWZmZXInIDogJyUnICxcbiAgICB9KSAsXG5cbiAgICBcImRlZlwiOiAoIHRyZWUgLCBtYXRjaCAsIHsgdmFyaWFibGVzIH0gKSA9PiB7XG4gICAgICBjb25zdCBbIGRlZiAsIG90aGVyY21kICwgXzIgLCBhbnl0aGluZyAsIF8zIF0gPSB0cmVlLmNoaWxkcmVuIDtcbiAgICAgIGNvbnN0IGNtZCA9IG90aGVyY21kLmJ1ZmZlcjtcbiAgICAgIHZhcmlhYmxlcy5zZXQoY21kLCBbMCwgYXN0Lm1hdGVyaWFsaXplKGFueXRoaW5nKV0pO1xuICAgICAgcmV0dXJuIGVtcHR5IDtcbiAgICB9ICxcblxuICAgIFwibmV3Y29tbWFuZFwiOiAoIHRyZWUgLCBtYXRjaCAsIGN0eCApID0+IHtcbiAgICAgIGNvbnN0IFsgbmV3Y29tbWFuZCAsIGNtZGRlZiBdID0gdHJlZS5jaGlsZHJlbiA7XG4gICAgICByZXR1cm4gdCggY21kZGVmICwgbWF0Y2ggLCBjdHggKSA7XG4gICAgfSAsXG5cbiAgICBcIiBcIiA6IHRyZWUgPT4gdHJlZSAsXG4gICAgXCJcXHRcIiA6IHRyZWUgPT4gdHJlZSAsXG4gICAgXCJcXG5cIiA6IHRyZWUgPT4gdHJlZSAsXG5cbiAgICBcImFyZ1wiOiAoIHRyZWUgLCBtYXRjaCAsIHsgYXJncyAsIHZhcmlhYmxlcyB9ICkgPT4ge1xuICAgICAgY29uc3QgWyBhcmcgXSA9IHRyZWUuY2hpbGRyZW4gO1xuICAgICAgaWYgKCBhcmdzLmxlbmd0aCA8IDIgKSB0aHJvdyBuZXcgRXJyb3IoYFJlcXVlc3RpbmcgJHthcmd9IGJ1dCBnb3Qgbm8gYXJndW1lbnRzIGluIGNvbnRleHQuYCkgO1xuICAgICAgY29uc3QgaSA9IHBhcnNlSW50KGFyZy5idWZmZXIuc3Vic3RyKDEpLCAxMCkgLSAxOyAvLyAjYXJnXG4gICAgICBpZiAoIGkgPj0gYXJnc1sxXS5sZW5ndGggKSB0aHJvdyBuZXcgRXJyb3IoYFJlcXVlc3RpbmcgJHthcmd9IGJ1dCBvbmx5IGdvdCAke2FyZ3NbMV0ubGVuZ3RofSBhcmd1bWVudHMuYCkgO1xuICAgICAgY29uc3Qgc3VidHJlZSA9IGFyZ3NbMV1baV0gOyAvLyBhcmdcbiAgICAgIHJldHVybiB0KCBzdWJ0cmVlICwgbWF0Y2ggLCB7IGFyZ3M6IGFyZ3NbMF0gLCB2YXJpYWJsZXMgfSApIDtcbiAgICB9ICxcblxuICAgIFwiJFwiIDogdHJlZSA9PiB0cmVlICxcblxuICAgIFwibWF0aFwiIDogKCB0cmVlICwgbWF0Y2ggLCBjdHggKSA9PiB7XG4gICAgICBjb25zdCBbIF9vcGVuICwgYW55dGhpbmcgLCBfY2xvc2UgXSA9IHRyZWUuY2hpbGRyZW4gO1xuICAgICAgcmV0dXJuIHtcblx0XCJ0eXBlXCIgOiBcIm5vZGVcIiAsXG5cdFwibm9udGVybWluYWxcIiA6ICdzb21ldGhpbmctZWxzZScgLFxuXHRcInByb2R1Y3Rpb25cIiA6IFwibWF0aFwiICxcblx0XCJjaGlsZHJlblwiIDogY2hhaW4oIFsgWyBfb3BlbiBdICwgbSggWyBhbnl0aGluZyBdICwgbWF0Y2ggLCBjdHggKSAsIFsgX2Nsb3NlIF0gXSApICxcbiAgICAgIH0gO1xuICAgIH0gLFxuXG4gICAgXCJtYXRoZW52XCIgOiAoIHRyZWUgLCBtYXRjaCAsIGN0eCApID0+IHtcbiAgICAgIGNvbnN0IFsgX29wZW4gLCBhbnl0aGluZyAsIF9jbG9zZSBdID0gdHJlZS5jaGlsZHJlbiA7XG4gICAgICByZXR1cm4ge1xuXHRcInR5cGVcIiA6IFwibm9kZVwiICxcblx0XCJub250ZXJtaW5hbFwiIDogJ3NvbWV0aGluZy1lbHNlJyAsXG5cdFwicHJvZHVjdGlvblwiIDogXCJtYXRoZW52XCIgLFxuXHRcImNoaWxkcmVuXCIgOiBjaGFpbiggWyBbIF9vcGVuIF0gLCBtKCBbIGFueXRoaW5nIF0gLCBtYXRjaCAsIGN0eCApICwgWyBfY2xvc2UgXSBdICkgLFxuICAgICAgfSA7XG4gICAgfSAsXG5cbiAgfSAsXG5cbiAgXCJlbmRpZlwiOiB7XG5cbiAgICBcImVsc2VmaVwiIDogKCB0cmVlICwgbWF0Y2ggLCBjdHggKSA9PiB7XG4gICAgICBjb25zdCBbIF9lbHNlICwgYW55dGhpbmcgLCBfZmkgXSA9IHRyZWUuY2hpbGRyZW4gO1xuICAgICAgcmV0dXJuIHtcblx0XCJ0eXBlXCIgOiBcIm5vZGVcIiAsXG5cdFwibm9udGVybWluYWxcIiA6IFwiZW5kaWZcIiAsXG5cdFwicHJvZHVjdGlvblwiIDogXCJlbHNlZmlcIiAsXG5cdFwiY2hpbGRyZW5cIiA6IGNoYWluKFsgWyBfZWxzZSBdICwgbSggWyBhbnl0aGluZyBdICwgbWF0Y2ggLCBjdHggKSAsIFsgX2ZpIF0gXSApICxcbiAgICAgIH0gO1xuICAgIH0gLFxuXG4gICAgXCJmaVwiIDogdHJlZSA9PiB0cmVlICxcblxuICB9ICxcblxuICBcImNtZGRlZlwiIDoge1xuXG4gICAgXCJ7Y21kfVt4XXthbnl0aGluZ31cIjogKCB0cmVlICwgXyAsIHsgdmFyaWFibGVzIH0gKSA9PiB7XG4gICAgICBjb25zdCBbIF8wICwgb3RoZXJjbWQgLCBfMSAsIGNtZGRlZmFyZ3MgLCBfMiAsIGFueXRoaW5nICwgXzMgXSA9IHRyZWUuY2hpbGRyZW4gO1xuICAgICAgY29uc3QgY21kID0gb3RoZXJjbWQuYnVmZmVyO1xuICAgICAgbGV0IG5hcmdzID0gMDtcbiAgICAgIGlmIChjbWRkZWZhcmdzLnByb2R1Y3Rpb24gPT09ICd5ZXMnKSB7XG5cdGNvbnN0IFsgXzQgLCB0ZXh0ICwgXzUgXSA9IGNtZGRlZmFyZ3MuY2hpbGRyZW4gO1xuXHRuYXJncyA9IHBhcnNlSW50KHRleHQuYnVmZmVyLCAxMCk7XG4gICAgICB9XG4gICAgICB2YXJpYWJsZXMuc2V0KGNtZCwgWyBuYXJncyAsIGFueXRoaW5nIF0pO1xuICAgICAgcmV0dXJuIGVtcHR5O1xuICAgIH0gLFxuXG4gICAgXCJjbWRbeF17YW55dGhpbmd9XCI6ICggdHJlZSAsIF8gLCB7IHZhcmlhYmxlcyB9ICkgPT4ge1xuICAgICAgY29uc3QgWyBvdGhlcmNtZCAsIGNtZGRlZmFyZ3MgLCBfMiAsIGFueXRoaW5nICwgXzMgXSA9IHRyZWUuY2hpbGRyZW4gO1xuICAgICAgY29uc3QgY21kID0gb3RoZXJjbWQuYnVmZmVyO1xuICAgICAgbGV0IG5hcmdzID0gMDtcbiAgICAgIGlmIChjbWRkZWZhcmdzLnByb2R1Y3Rpb24gPT09ICd5ZXMnKSB7XG5cdGNvbnN0IFsgXzQgLCB0ZXh0ICwgXzUgXSA9IGNtZGRlZmFyZ3MuY2hpbGRyZW4gO1xuXHRuYXJncyA9IHBhcnNlSW50KHRleHQuYnVmZmVyLCAxMCk7XG4gICAgICB9XG4gICAgICB2YXJpYWJsZXMuc2V0KGNtZCwgWyBuYXJncyAsIGFueXRoaW5nIF0pO1xuICAgICAgcmV0dXJuIGVtcHR5O1xuICAgIH0gLFxuXG4gICAgXCIqY21kW3hde2FueXRoaW5nfVwiOiAoIHRyZWUgLCBfICwgeyB2YXJpYWJsZXMgfSApID0+IHtcbiAgICAgIC8vIGRvIG5vdCBrbm93IHdoYXQgdG8gZG8gd2l0aCAnKicgYXQgdGhlIG1vbWVudFxuICAgICAgY29uc3QgWyBfMSAsIG90aGVyY21kICwgY21kZGVmYXJncyAsIF8yICwgYW55dGhpbmcgLCBfMyBdID0gdHJlZS5jaGlsZHJlbiA7XG4gICAgICBjb25zdCBjbWQgPSBvdGhlcmNtZC5idWZmZXI7XG4gICAgICBsZXQgbmFyZ3MgPSAwO1xuICAgICAgaWYgKGNtZGRlZmFyZ3MucHJvZHVjdGlvbiA9PT0gJ3llcycpIHtcblx0Y29uc3QgWyBfNCAsIHRleHQgLCBfNSBdID0gY21kZGVmYXJncy5jaGlsZHJlbiA7XG5cdG5hcmdzID0gcGFyc2VJbnQodGV4dC5idWZmZXIsIDEwKTtcbiAgICAgIH1cbiAgICAgIHZhcmlhYmxlcy5zZXQoY21kLCBbIG5hcmdzICwgYW55dGhpbmcgXSk7XG4gICAgICByZXR1cm4gZW1wdHk7XG4gICAgfSAsXG5cbiAgfSAsXG5cbiAgXCJjbWRkZWZhcmdzXCI6IHtcbiAgICBcInllc1wiIDogZXJyKCBcImNtZGRlZmFyZ3NcIiAsIFwieWVzXCIgKSAsXG4gICAgXCJub1wiIDogZXJyKCBcImNtZGRlZmFyZ3NcIiAsIFwibm9cIiApICxcbiAgfSAsXG5cbiAgXCJjbWQqXCI6IHtcbiAgICBcInllc1wiIDogZXJyKCBcImNtZCpcIiAsIFwieWVzXCIgKSAsXG4gICAgXCJub1wiIDogZXJyKCBcImNtZCpcIiAsIFwibm9cIiApICxcbiAgfSAsXG5cbiAgXCJjbWRhcmdzXCI6IHtcbiAgICBcIm5vcm1hbFwiIDogcmVjdXJzZSgnY21kYXJncycsICdub3JtYWwnKSAsXG4gICAgXCJvcHRpb25hbFwiIDogcmVjdXJzZSgnY21kYXJncycsICdvcHRpb25hbCcpICxcbiAgICBcImVuZFwiIDogKCkgPT4gZW1wdHkgLFxuICB9ICxcblxuICBcImNtZGFmdGVyXCI6IHtcbiAgICBcIm90aGVyY21kXCIgOiByZWN1cnNlKCdjbWRhZnRlcicsICdvdGhlcmNtZCcgKSAsXG4gICAgXCJzb21ldGhpbmctZWxzZS10aGVuLWFueXRoaW5nXCIgOiByZWN1cnNlKCdjbWRhZnRlcicsICdzb21ldGhpbmctZWxzZS10aGVuLWFueXRoaW5nJyApICxcbiAgICBcIl0tdGhlbi1hbnl0aGluZ1wiIDogcmVjdXJzZSgnY21kYWZ0ZXInLCAnXS10aGVuLWFueXRoaW5nJyApICxcbiAgICBcIm5vdGhpbmdcIiA6ICgpID0+IGVtcHR5ICxcbiAgfSAsXG5cbiAgXCJjbWRhZnRlci1idXQtbm90LV1cIjoge1xuICAgIFwib3RoZXJjbWRcIiA6IHJlY3Vyc2UoJ2NtZGFmdGVyLWJ1dC1ub3QtXScsICdvdGhlcmNtZCcgKSAsXG4gICAgXCJzb21ldGhpbmctZWxzZS10aGVuLWFueXRoaW5nXCIgOiByZWN1cnNlKCdjbWRhZnRlci1idXQtbm90LV0nLCAnc29tZXRoaW5nLWVsc2UtdGhlbi1hbnl0aGluZycgKSAsXG4gICAgXCJub3RoaW5nXCIgOiAoKSA9PiBlbXB0eSAsXG4gIH0gLFxuXG59IDtcbiJdfQ==